

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/world.png">
  <link rel="icon" href="/img/world.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#3e424a">
  <meta name="author" content="Yanjing">
  <meta name="keywords" content="">
  
    <meta name="description" content="地址：https:&#x2F;&#x2F;github.com&#x2F;ROCm&#x2F;ROCK-Kernel-Driver">
<meta property="og:type" content="article">
<meta property="og:title" content="AMD GPU KMD 代码分析">
<meta property="og:url" content="http://yoursite.com/2024/08/19/amdgpu-kmd/index.html">
<meta property="og:site_name" content="TechOdyssey">
<meta property="og:description" content="地址：https:&#x2F;&#x2F;github.com&#x2F;ROCm&#x2F;ROCK-Kernel-Driver">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/img/gpu/amd/index.png">
<meta property="article:published_time" content="2024-08-19T13:53:19.000Z">
<meta property="article:modified_time" content="2024-10-08T13:01:04.993Z">
<meta property="article:author" content="Yanjing">
<meta property="article:tag" content="GPU">
<meta property="article:tag" content="KMD">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://yoursite.com/img/gpu/amd/index.png">
  
  
  
  <title>AMD GPU KMD 代码分析 - TechOdyssey</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/icon.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yoursite.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":15,"cursorChar":"|","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":"❡"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Tech Odyssey</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>Links</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-bookmark-fill"></i>
                <span>Favor</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="https://vercel.com/" target="_self">
                    <i class="iconfont icon-vercel"></i>
                    <span>Vercel</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/pdf/" target="_self">
                    <i class="iconfont icon-pdf-new"></i>
                    <span>PDF</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://www.google.com/" target="_self">
                    <i class="iconfont icon-google-new"></i>
                    <span>Google</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://www.baidu.com/" target="_self">
                    <i class="iconfont icon-baidu-new"></i>
                    <span>Baidu</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://github.com" target="_self">
                    <i class="iconfont icon-github-new"></i>
                    <span>Github</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://www.zhihu.com" target="_self">
                    <i class="iconfont icon-zhihu-new"></i>
                    <span>Zhihu</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://www.bilibili.com/" target="_self">
                    <i class="iconfont icon-bilibili-new"></i>
                    <span>Bilibili</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://chat.openai.com/" target="_self">
                    <i class="iconfont icon-chatGPT"></i>
                    <span>Chatgpt</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://msdn.itellyou.cn/" target="_self">
                    <i class="iconfont icon-microsoft"></i>
                    <span>MSDN</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://www.iconfont.cn/" target="_self">
                    <i class="iconfont icon-iconfont"></i>
                    <span>Ali Icon</span>
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/back_1.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.1)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="AMD GPU KMD 代码分析"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-08-19 13:53" pubdate>
          2024年8月19日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          15k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          126 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">AMD GPU KMD 代码分析</h1>
            
            
              <div class="markdown-body">
                
                <p>地址：<a href="https://github.com/ROCm/ROCK-Kernel-Driver">https://github.com/ROCm/ROCK-Kernel-Driver</a></p>
<span id="more"></span>

<h2 id="驱动"><a href="#驱动" class="headerlink" title="驱动"></a>驱动</h2><p><a href="/img/gpu/amd/amdgpu_load.xmind">Total Xmind</a></p>
<details>
<summary>流程示意图</summary>

<pre><code class=" mermaid">flowchart TB
    amdgpu_driver_load_kms --&gt; amdgpu_device_init --&gt;  amdgpu_device_ip_early_init

    subgraph amdgpu_device_ip_early_init
        direction TB
        amdgpu_discovery_set_ip_blocks --&gt; amdgpu_amdkfd_device_probe
        amdgpu_amdkfd_device_probe --&gt; early_init
        subgraph early_init
            direction TB
            uvd_v7_0_early_init  --&gt; ... --&gt; vce_v4_0_early_init
        end
    end

    amdgpu_device_init --&gt; amdgpu_device_ip_init
    
    amdgpu_device_ip_init --&gt; sw_init
    subgraph sw_init
        direction TB
        gmc_v9_0_sw_init --&gt; gmc_v9_0_mc_init --&gt; amdgpu_bo_init --&gt; gmc_v9_0_gart_init --&gt; vega20_ih_sw_init --&gt; psp_sw_init --&gt; pp_sw_init --&gt; gfx_v9_0_sw_init --&gt; uvd_v7_0_sw_init --&gt; vce_v4_0_sw_init
    end

    amdgpu_device_ip_init --&gt; hw_init
    subgraph hw_init
        direction TB
        gmc_v9_0_hw_init --&gt; psp_hw_init --&gt; dm_hw_init --&gt; gfx_v9_0_hw_init --&gt; sdma_v4_0_hw_init --&gt; vce_v4_0_hw_init
    end

    amdgpu_device_ip_init --&gt; amdgpu_amdkfd_device_init --&gt; kgd2kfd_device_init
    subgraph kgd2kfd_device_init
        direction TB
        kfd_gtt_sa_init --&gt; kfd_doorbell_init --&gt; device_queue_manager_init
    end

    amdgpu_device_init --&gt; amdgpu_device_ip_late_init
</code></pre>

</details>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-28ab9646" role="button" aria-expanded="false" aria-controls="collapse-28ab9646">
        <div class="fold-arrow">▶</div>AMD GPU kmd load function and log
      </div>
      <div class="fold-collapse collapse" id="collapse-28ab9646">
        <div class="fold-content">
          <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br></pre></td><td class="code"><pre><code class="hljs c">amd/amdgpu/amdgpu_drv.c: amdgpu_init()<br>[<span class="hljs-number">22906.629931</span>] [drm] amdgpu kernel modesetting enabled.<br>[<span class="hljs-number">22906.629932</span>] [drm] amdgpu test <span class="hljs-keyword">for</span> PM4 packet version: <span class="hljs-number">5.18</span><span class="hljs-number">.13</span><br>[<span class="hljs-number">22906.629932</span>] [drm] OS DRM version: <span class="hljs-number">5.4</span><span class="hljs-number">.0</span><br>--&gt; amdgpu_register_atpx_handler()<br>--&gt; amdgpu_acpi_detect()<br>--&gt; amd/amdgpu/amdgpu_amdkfd.c: amdgpu_amdkfd_init()<br>    --&gt; amd/amdkfd/kfd_module.c: kgd2kfd_init()<br>        --&gt; &lt;<span class="hljs-keyword">if</span> <span class="hljs-title function_">IS_ENABLED</span><span class="hljs-params">(CONFIG_HSA_AMD)</span>&gt;: amd/amdkfd/kfd_module.c: <span class="hljs-title function_">kfd_init</span><span class="hljs-params">()</span><br>            --&gt; amd/amdkfd/kfd_chardev.c: <span class="hljs-title function_">kfd_chardev_init</span><span class="hljs-params">()</span><br>                --&gt; <span class="hljs-title function_">register_chrdev</span><span class="hljs-params">(<span class="hljs-number">0</span>, kfd_dev_name, &amp;kfd_fops)</span><br>                --&gt; <span class="hljs-title function_">class_create</span><span class="hljs-params">(THIS_MODULE, kfd_dev_name)</span><br>                --&gt; <span class="hljs-title function_">device_create</span><span class="hljs-params">(kfd_class, <span class="hljs-literal">NULL</span>, MKDEV(kfd_char_dev_major, <span class="hljs-number">0</span>), <span class="hljs-literal">NULL</span>, kfd_dev_name)</span><br>            --&gt; amd/amdkfd/kfd_topology.c: <span class="hljs-title function_">kfd_topology_init</span><span class="hljs-params">()</span><br>                --&gt; &lt;<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ACPI&gt;: ret = kfd_create_crat_image_acpi(&amp;crat_image, &amp;image_size)</span><br>                    [22906.630016] amdgpu: CRAT table not found<br>                --&gt; amd/amdkfd/kfd_crat.c: <span class="hljs-title function_">kfd_create_crat_image_virtual</span><span class="hljs-params">(&amp;crat_image, &amp;image_size, COMPUTE_UNIT_CPU, <span class="hljs-literal">NULL</span>, proximity_domain)</span><br>                    [22906.630017] [244191] amdgpu: CRAT size is 128<br>                    --&gt; amd/amdkfd/kfd_crat.c: <span class="hljs-title function_">kfd_create_vcrat_image_cpu</span><span class="hljs-params">(pcrat_image, size)</span><br>                        [22906.630018] amdgpu: Virtual CRAT table created <span class="hljs-keyword">for</span> CPU<br>                --&gt; amd/amdkfd/kfd_crat.c: <span class="hljs-title function_">kfd_parse_crat_table</span><span class="hljs-params">(crat_image, &amp;temp_topology_device_list, proximity_domain)</span><br>                    [22906.630019] [244191] amdgpu: Parsing CRAT table with 1 nodes<br>                    --&gt; <span class="hljs-title function_">kfd_parse_subtype</span><span class="hljs-params">()</span><br>                        --&gt; <span class="hljs-title function_">kfd_parse_subtype_cu</span><span class="hljs-params">()</span><br>                            [22906.630019] [244191] amdgpu: Found CU entry in CRAT table with proximity_domain=<span class="hljs-number">0</span> caps=<span class="hljs-number">0</span><br>                            --&gt; kfd_populated_cu_info_cpu()<br>                                [<span class="hljs-number">22906.630020</span>] [<span class="hljs-number">244191</span>] amdgpu: CU CPU: cores=<span class="hljs-number">12</span> id_base=<span class="hljs-number">0</span><br>                --&gt; kfd_debug_print_topology()<br>                    [<span class="hljs-number">22906.630027</span>] amdgpu: Topology: Add CPU node<br>            --&gt; kfd_ipc_init()<br>            --&gt; kfd_process_create_wq()<br>            --&gt; kfd_init_peer_direct()<br>                [<span class="hljs-number">22906.630082</span>] [<span class="hljs-number">244191</span>] amdgpu: Try to initialize PeerDirect support<br>                [<span class="hljs-number">22906.631966</span>] [<span class="hljs-number">244191</span>] amdgpu: PeerDirect interface was not detected<br>            --&gt; kfd_procfs_init()<br>            --&gt; kfd_debugfs_init()<br>            --&gt; &lt;<span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DEFINE_SRCU&gt;: kfd_init_processes_srcu()</span><br>    --&gt; amdgpu_amdkfd_gpuvm_init_mem_limits()<br>        [<span class="hljs-number">22906.631979</span>] [<span class="hljs-number">244191</span>] amdgpu: Kernel memory limit <span class="hljs-number">12427</span>M, TTM limit <span class="hljs-number">4971</span>M<br>--&gt; pci_register_driver(&amp;amdgpu_kms_pci_driver)<br> <br> <br> <br> <br> <br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> pci_driver amdgpu_kms_pci_driver = &#123;<br>    .name = DRIVER_NAME,<br>    .id_table = pciidlist,<br>    .probe = amdgpu_pci_probe,<br>    .remove = amdgpu_pci_remove,<br>    .shutdown = amdgpu_pci_shutdown,<br>    .driver.pm = &amp;amdgpu_pm_ops,<br>    .err_handler = &amp;amdgpu_pci_err_handler,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> HAVE_PCI_DRIVER_DEV_GROUPS</span><br>    .dev_groups = amdgpu_sysfs_groups,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br> <br> <br>amd/amdgpu/amdgpu_drv.c: amdgpu_pci_probe()<br>--&gt; drm_aperture_remove_conflicting_pci_framebuffers()<br>    --&gt; _kcl_remove_conflicting_pci_framebuffers()<br>        --&gt; remove_conflicting_pci_framebuffers()<br>            [<span class="hljs-number">22906.632001</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: remove_conflicting_pci_framebuffers: bar <span class="hljs-number">0</span>: <span class="hljs-number">0x2400000000</span> -&gt; <span class="hljs-number">0x27ffffffff</span><br>            [<span class="hljs-number">22906.632001</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: remove_conflicting_pci_framebuffers: bar <span class="hljs-number">2</span>: <span class="hljs-number">0x2200000000</span> -&gt; <span class="hljs-number">0x22001fffff</span><br>            [<span class="hljs-number">22906.632002</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: remove_conflicting_pci_framebuffers: bar <span class="hljs-number">5</span>: <span class="hljs-number">0xf7b00000</span> -&gt; <span class="hljs-number">0xf7b7ffff</span><br>--&gt; ...<br>--&gt; amd/amdgpu/amdgpu_kms.c: amdgpu_driver_load_kms()<br>    --&gt; amd/amdgpu/amdgpu_device.c: amdgpu_device_init()<br>        [<span class="hljs-number">22906.632089</span>] [drm] initializing kernel <span class="hljs-title function_">modesetting</span> <span class="hljs-params">(VEGA20 <span class="hljs-number">0x1002</span>:<span class="hljs-number">0x66AF</span> <span class="hljs-number">0x1002</span>:<span class="hljs-number">0x081E</span> <span class="hljs-number">0xC1</span>)</span>.<br>        [22906.632099] [drm] <span class="hljs-keyword">register</span> mmio base: 0xF7B00000<br>        [22906.632100] [drm] <span class="hljs-keyword">register</span> mmio size: 524288<br>        --&gt; <span class="hljs-title function_">amdgpu_device_ip_early_init</span><span class="hljs-params">()</span><br>            --&gt; <span class="hljs-title function_">amdgpu_discovery_set_ip_blocks</span><span class="hljs-params">()</span><br>                --&gt; <span class="hljs-title function_">amdgpu_discovery_set_common_ip_blocks</span><span class="hljs-params">()</span><br>                --&gt; ...<br>                --&gt; <span class="hljs-title function_">amdgpu_discovery_set_sdma_ip_blocks</span><span class="hljs-params">()</span><br>                    --&gt; <span class="hljs-title function_">amdgpu_device_ip_block_add</span><span class="hljs-params">(adev, &amp;sdma_v4_0_ip_block)</span><br>                --&gt; <span class="hljs-title function_">amdgpu_discovery_set_mm_ip_blocks</span><span class="hljs-params">()</span><br>                    --&gt; <span class="hljs-title function_">amdgpu_device_ip_block_add</span><span class="hljs-params">(adev, &amp;uvd_v7_0_ip_block)</span>;<br>                --&gt; amdgpu_discovery_set_mes_ip_blocks()<br>                    --&gt; amdgpu_device_ip_block_add()<br>                        [<span class="hljs-number">22906.632143</span>] [drm] add ip block number <span class="hljs-number">0</span> &lt;soc15_common&gt;<br>                        [<span class="hljs-number">22906.632143</span>] [drm] add ip block number <span class="hljs-number">1</span> &lt;gmc_v9_0&gt;<br>                        [<span class="hljs-number">22906.632144</span>] [drm] add ip block number <span class="hljs-number">2</span> &lt;vega20_ih&gt;<br>                        [<span class="hljs-number">22906.632144</span>] [drm] add ip block number <span class="hljs-number">3</span> &lt;psp&gt;<br>                        [<span class="hljs-number">22906.632144</span>] [drm] add ip block number <span class="hljs-number">4</span> &lt;powerplay&gt;<br>                        [<span class="hljs-number">22906.632145</span>] [drm] add ip block number <span class="hljs-number">5</span> &lt;dm&gt;<br>                        [<span class="hljs-number">22906.632145</span>] [drm] add ip block number <span class="hljs-number">6</span> &lt;gfx_v9_0&gt;<br>                        [<span class="hljs-number">22906.632146</span>] [drm] add ip block number <span class="hljs-number">7</span> &lt;sdma_v4_0&gt;<br>                        [<span class="hljs-number">22906.632146</span>] [drm] add ip block number <span class="hljs-number">8</span> &lt;uvd_v7_0&gt;<br>                        [<span class="hljs-number">22906.632147</span>] [drm] add ip block number <span class="hljs-number">9</span> &lt;vce_v4_0&gt;<br>            --&gt; amdgpu_amdkfd_device_probe() ★<br>            --&gt; adev-&gt;ip_blocks[i].version-&gt;funcs-&gt;early_init()<br>                --&gt; uvd_v7_0_ip_funcs.early_init() = uvd_v7_0_early_init()<br>                    --&gt; uvd_v7_0_set_ring_funcs()<br>                        [<span class="hljs-number">22906.726994</span>] [drm] UVD(<span class="hljs-number">0</span>) is enabled in VM mode<br>                        [<span class="hljs-number">22906.726995</span>] [drm] UVD(<span class="hljs-number">1</span>) is enabled in VM mode<br>                        uvd_v7_0_set_enc_ring_funcs()<br>                        [<span class="hljs-number">22906.726995</span>] [drm] UVD(<span class="hljs-number">0</span>) ENC is enabled in VM mode<br>                        [<span class="hljs-number">22906.726995</span>] [drm] UVD(<span class="hljs-number">1</span>) ENC is enabled in VM mode<br>                --&gt; vce_v4_0_ip_funcs.early_init() = vce_v4_0_early_init()<br>                    --&gt; vce_v4_0_set_ring_funcs()<br>                        [<span class="hljs-number">22906.726996</span>] [drm] VCE enabled in VM mode<br>            --&gt; amdgpu_get_bios()<br>                [<span class="hljs-number">22906.726968</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: Fetched VBIOS from ROM BAR<br>            --&gt; amdgpu_atombios_init()<br>                --&gt; amdgpu_atom_parse()<br>                [<span class="hljs-number">22906.726969</span>] amdgpu: ATOM BIOS: <span class="hljs-number">113</span>-D3600200<span class="hljs-number">-106</span><br>        --&gt; amdgpu_gmc_tmz_set()<br>            [<span class="hljs-number">22906.726996</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: Trusted Memory Zone (TMZ) feature not supported<br>        --&gt; amdgpu_device_doorbell_init()<br>        --&gt; amdgpu_device_ip_init()<br>            --&gt; amdgpu_ras_init()<br>                --&gt; amdgpu_ras_check_supported()<br>                    [<span class="hljs-number">22906.727016</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: MEM ECC is not presented.<br>                    [<span class="hljs-number">22906.727016</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: SRAM ECC is not presented.<br>                [<span class="hljs-number">22906.727019</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: RAS INFO: ras initialized successfully, hardware ability[<span class="hljs-number">4</span>] ras_mask[<span class="hljs-number">4</span>]<br>            --&gt; adev-&gt;ip_blocks[i].version-&gt;funcs-&gt;sw_init((<span class="hljs-type">void</span> *)adev)<br>                gmc_v9_0_ip_funcs.sw_init = gmc_v9_0_sw_init()<br>                --&gt; amdgpu_vm_adjust_size()<br>                    [<span class="hljs-number">22906.727024</span>] [drm] vm size is <span class="hljs-number">262144</span> GB, <span class="hljs-number">4</span> levels, block size is <span class="hljs-number">9</span>-bit, fragment size is <span class="hljs-number">9</span>-bit<br>                --&gt; gmc_v9_0_mc_init()<br>                    --&gt; gmc_v9_0_vram_gtt_location()<br>                        --&gt; amdgpu_gmc_vram_location(adev, mc, base);<br>                            [<span class="hljs-number">22906.727028</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: VRAM: <span class="hljs-number">16368</span>M <span class="hljs-number">0x0000008000000000</span> - <span class="hljs-number">0x00000083FEFFFFFF</span> (<span class="hljs-number">16368</span>M used)<br>                        --&gt; amdgpu_gmc_gart_location(adev, mc);<br>                            [<span class="hljs-number">22906.727028</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: GART: <span class="hljs-number">512</span>M <span class="hljs-number">0x0000000000000000</span> - <span class="hljs-number">0x000000001FFFFFFF</span><br>                        --&gt; amdgpu_gmc_agp_location(adev, mc);<br>                            [<span class="hljs-number">22906.727029</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: AGP: <span class="hljs-number">267894784</span>M <span class="hljs-number">0x0000008400000000</span> - <span class="hljs-number">0x0000FFFFFFFFFFFF</span><br>                --&gt; amdgpu_bo_init()<br>                        [<span class="hljs-number">22906.727033</span>] [drm] Detected VRAM RAM=<span class="hljs-number">16368</span>M, BAR=<span class="hljs-number">16384</span>M<br>                        [<span class="hljs-number">22906.727034</span>] [drm] RAM width <span class="hljs-number">4096b</span>its HBM\<br>                    --&gt; amdgpu_ttm_init()<br>                        [<span class="hljs-number">22906.730061</span>] [drm] amdgpu: <span class="hljs-number">16368</span>M of VRAM memory ready<br>                        [<span class="hljs-number">22906.730062</span>] [drm] amdgpu: <span class="hljs-number">15985</span>M of GTT memory ready.<br>                --&gt; gmc_v9_0_gart_init()<br>                    --&gt; amdgpu_gart_init()<br>                        [<span class="hljs-number">22906.730070</span>] [drm] GART: num cpu pages <span class="hljs-number">131072</span>, num gpu pages <span class="hljs-number">131072</span><br>                vega20_ih_ip_funcs.sw_init = vega20_ih_sw_init()<br>                --&gt; amdgpu_irq_init()<br>                    [<span class="hljs-number">22906.730197</span>] [<span class="hljs-number">244191</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: using MSI/MSI-X.<br>                psp_ip_funcs.sw_init = psp_sw_init()<br>                --&gt; psp_get_runtime_db_entry()<br>                    [<span class="hljs-number">22906.730299</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: PSP runtime database doesn<span class="hljs-number">&#x27;</span>t exist<br>                    [<span class="hljs-number">22906.730305</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: PSP runtime database doesn<span class="hljs-number">&#x27;</span>t exist<br>                pp_ip_funcs.sw_init = pp_sw_init()<br>                --&gt; hwmgr_sw_init()<br>                    [<span class="hljs-number">22906.730357</span>] amdgpu: [powerplay] hwmgr_sw_init smu backed is vega20_smu<br>                gfx_v9_0_ip_funcs.sw_init = gfx_v9_0_sw_init()<br>                --&gt; gfx_v9_0_mec_init()<br>                    --&gt; amdgpu_gfx_compute_queue_acquire()<br>                        [<span class="hljs-number">22906.730665</span>] [<span class="hljs-number">244191</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: mec <span class="hljs-built_in">queue</span> bitmap weight=<span class="hljs-number">8</span><br>                uvd_v7_0_ip_funcs.sw_init = uvd_v7_0_sw_init()<br>                --&gt; amdgpu_uvd_sw_init()<br>                    [<span class="hljs-number">22906.731269</span>] [drm] Found UVD firmware ENC: <span class="hljs-number">1.2</span> DEC: <span class="hljs-number">.43</span> Family ID: <span class="hljs-number">19</span><br>                [<span class="hljs-number">22906.731284</span>] [drm] PSP loading UVD firmware<br>                vce_v4_0_ip_funcs.sw_init = vce_v4_0_sw_init()<br>                --&gt; amdgpu_vce_sw_init()<br>                    [<span class="hljs-number">22906.732037</span>] [drm] Found VCE firmware Version: <span class="hljs-number">57.6</span> Binary ID: <span class="hljs-number">4</span><br>                [<span class="hljs-number">22906.732061</span>] [drm] PSP loading VCE firmware<br>            --&gt; adev-&gt;ip_blocks[i].version-&gt;funcs-&gt;hw_init((<span class="hljs-type">void</span> *)adev)<br>                gmc_v9_0_ip_funcs.hw_init = gmc_v9_0_hw_init()<br>                --&gt; gmc_v9_0_gart_enable()<br>                    [<span class="hljs-number">22906.730140</span>] [drm] PCIE GART of <span class="hljs-number">512</span>M enabled.<br>                    [<span class="hljs-number">22906.730140</span>] [drm] PTB located at <span class="hljs-number">0x0000008000000000</span><br> <br>                psp_ip_funcs.hw_init = psp_hw_init()<br>                --&gt; psp_load_fw()<br>                    --&gt; psp_hw_start()<br>                        --&gt; psp_tmr_load()<br>                            [<span class="hljs-number">22906.752341</span>] [drm] reserve <span class="hljs-number">0x400000</span> from <span class="hljs-number">0x83fec00000</span> <span class="hljs-keyword">for</span> PSP TMR<br>                    --&gt; psp_hdcp_initialize()<br>                        [<span class="hljs-number">22906.886713</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: HDCP: optional hdcp ta ucode is not available<br>                    --&gt; psp_dtm_initialize()<br>                        [<span class="hljs-number">22906.886716</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: DTM: optional dtm ta ucode is not available<br>                    --&gt; psp_rap_initialize()<br>                        [<span class="hljs-number">22906.886719</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: RAP: optional rap ta ucode is not available<br>                    --&gt; psp_securedisplay_initialize()<br>                        [<span class="hljs-number">22906.886721</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: SECUREDISPLAY: securedisplay ta ucode is not available<br> <br>                amdgpu_dm_funcs.hw_init = dm_hw_init()<br>                --&gt; amdgpu_dm_init()<br>                    --&gt; dc_create(&amp;init_data)<br>                        --&gt; dc_construct(dc, init_params)<br>                            --&gt; dc_clk_mgr_create(dc-&gt;ctx, dc-&gt;res_pool-&gt;pp_smu, dc-&gt;res_pool-&gt;dccg)<br>                                --&gt; dceXXX_clk_mgr_construct()<br>                                    --&gt; ...<br>                                    --&gt; vbios_funcs.get_spread_spectrum_info = bios_parser_get_spread_spectrum_info()<br>                                    --&gt; get_ss_info_v4_1()<br>                                        [<span class="hljs-number">22906.890253</span>] [<span class="hljs-number">244191</span>] amdgpu: [BIOS]:gpuclk_ss_percentage (unit of <span class="hljs-number">0.001</span> percent): <span class="hljs-number">0</span><br>                                        [<span class="hljs-number">22906.890388</span>] [<span class="hljs-number">244191</span>] amdgpu: [BIOS]:AS_SIGNAL_TYPE_DISPLAY_PORT ss_percentage: <span class="hljs-number">450</span><br>                            --&gt; create_links(dc, init_params-&gt;num_virtual_links)<br>                                --&gt; link_create()<br>                                    --&gt; dc_link_construct(link, init_params))<br>                                        --&gt; dc_link_construct_legacy()<br>                                            --&gt; link-&gt;dc-&gt;res_pool-&gt;funcs-&gt;link_enc_create(dc_ctx, &amp;enc_init_data)<br>                                                .link_enc_create = dceXXX_link_encoder_create<br>                                                --&gt; dceXXX_link_encoder_construct()<br>                                                    --&gt; bp_funcs-&gt;get_encoder_cap_info(enc110-&gt;base.ctx-&gt;dc_bios, enc110-&gt;base.id, &amp;bp_cap_info)<br>                                                        vbios_funcs.get_encoder_cap_info = bios_parser_get_encoder_cap_info()<br>                                                        bios_parser_get_encoder_cap_info()<br>                                                        [<span class="hljs-number">22906.890474</span>] [<span class="hljs-number">244191</span>] amdgpu: [BIOS]:record-&gt;encodercaps <span class="hljs-number">0xf</span> <span class="hljs-keyword">for</span> object_id <span class="hljs-number">0xd</span><br>                                                        [<span class="hljs-number">22906.890476</span>] [<span class="hljs-number">244191</span>] amdgpu: [BIOS]:  info-&gt;DP_IS_USB_C <span class="hljs-number">0</span><br>                                                        [<span class="hljs-number">22906.890501</span>] [<span class="hljs-number">244191</span>] amdgpu: [BIOS]:record-&gt;encodercaps <span class="hljs-number">0xf</span> <span class="hljs-keyword">for</span> object_id <span class="hljs-number">0xf</span><br>                                                        [<span class="hljs-number">22906.890503</span>] [<span class="hljs-number">244191</span>] amdgpu: [BIOS]:  info-&gt;DP_IS_USB_C <span class="hljs-number">0</span><br>                                                        [<span class="hljs-number">22906.890527</span>] [<span class="hljs-number">244191</span>] amdgpu: [BIOS]:record-&gt;encodercaps <span class="hljs-number">0xf</span> <span class="hljs-keyword">for</span> object_id <span class="hljs-number">0xf</span><br>                                                        [<span class="hljs-number">22906.890529</span>] [<span class="hljs-number">244191</span>] amdgpu: [BIOS]:  info-&gt;DP_IS_USB_C <span class="hljs-number">0</span><br>                                                        [<span class="hljs-number">22906.890553</span>] [<span class="hljs-number">244191</span>] amdgpu: [BIOS]:record-&gt;encodercaps <span class="hljs-number">0xf</span> <span class="hljs-keyword">for</span> object_id <span class="hljs-number">0xd</span><br>                                                        [<span class="hljs-number">22906.890555</span>] [<span class="hljs-number">244191</span>] amdgpu: [BIOS]:  info-&gt;DP_IS_USB_C <span class="hljs-number">0</span><br>                    [<span class="hljs-number">22906.890570</span>] [drm] Display Core initialized with v3<span class="hljs-number">.2</span><span class="hljs-number">.212</span>!<br> <br>                gfx_v9_0_ip_funcs.hw_init = gfx_v9_0_hw_init()<br>                --&gt; gfx_v9_0_cp_resume()<br>                    --&gt; gfx_v9_0_kcq_resume()<br>                        --&gt; amdgpu_gfx_enable_kcq()<br>                            [<span class="hljs-number">22906.894733</span>] [drm] kiq ring mec <span class="hljs-number">2</span> pipe <span class="hljs-number">1</span> q <span class="hljs-number">0</span><br> <br>                sdma_v4_0_ip_funcs.hw_init = sdma_v4_0_hw_init()<br>                --&gt; amdgpu_dpm_set_powergating_by_smu()<br>                    --&gt; p_dpm_funcs.set_powergating_by_smu = pp_set_powergating_by_smu()<br>                        --&gt; pp_dpm_powergate_uvd()<br>                            --&gt; <span class="hljs-keyword">if</span> (hwmgr-&gt;hwmgr_func-&gt;powergate_uvd == <span class="hljs-literal">NULL</span>)<br>                                vega20_hwmgr_funcs.powergate_uvd = vega20_power_gate_uvd()<br>                                vega20_power_gate_uvd()<br>                                --&gt; vega20_enable_disable_uvd_dpm()<br>                                    [<span class="hljs-number">22906.936879</span>] [<span class="hljs-number">244191</span>] amdgpu: [powerplay] [EnableDisableUVDDPM] feature DPM UVD already enabled!<br>                uvd_v6_0_ip_funcs.hw_init = uvd_v6_0_hw_init()<br>                [<span class="hljs-number">22906.937023</span>] [drm] UVD and UVD ENC initialized successfully.<br> <br>                <span class="hljs-comment">// --&gt; amdgpu_dpm_set_powergating_by_smu()</span><br>                <span class="hljs-comment">//     --&gt; p_dpm_funcs.set_powergating_by_smu = pp_set_powergating_by_smu()</span><br>                <span class="hljs-comment">//         --&gt; pp_dpm_powergate_vce()</span><br>                <span class="hljs-comment">//             --&gt; vega20_hwmgr_funcs.powergate_vce = vega20_power_gate_vce()</span><br>                <span class="hljs-comment">//                 --&gt; vega20_enable_disable_vce_dpm()</span><br>                <span class="hljs-comment">//                     [22907.135666] [244191] amdgpu: [powerplay] [EnableDisableVCEDPM] feature VCE DPM already enabled!</span><br>                vce_v4_0_ip_funcs.hw_init = vce_v4_0_hw_init()<br>                [<span class="hljs-number">22907.135956</span>] [drm] VCE initialized successfully.<br> <br>                <span class="hljs-comment">// smu_v11_0_i2c_algo.master_xfer = smu_v11_0_i2c_xfer</span><br>                <span class="hljs-comment">// smu_v11_0_i2c_xfer()</span><br>                <span class="hljs-comment">//     smu_v11_0_i2c_write_data()</span><br>                <span class="hljs-comment">//         smu_v11_0_i2c_transmit()</span><br>                <span class="hljs-comment">//             smu_v11_0_i2c_poll_tx_status()</span><br>                <span class="hljs-comment">//             [22907.141263] [drm] TX was terminated, IC_TX_ABRT_SOURCE val is:1000001</span><br>                <span class="hljs-comment">//         [22907.141357] [drm:smu_v11_0_i2c_xfer.cold [amdgpu]] *ERROR* Received I2C_NAK_7B_ADDR_NOACK !!!</span><br>                <span class="hljs-comment">//     [22907.141410] [drm:smu_v11_0_i2c_xfer [amdgpu]] *ERROR* WriteI2CData() - I2C error occurred :1</span><br> <br>            --&gt; amdgpu_ras_recovery_init()<br>                --&gt; amdgpu_ras_eeprom_init()<br>                    [<span class="hljs-number">22907.142252</span>] [drm:amdgpu_ras_eeprom_init [amdgpu]] *ERROR* Failed to read EEPROM table header, res:<span class="hljs-number">-5</span><br>                [<span class="hljs-number">22907.142811</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: Failed to initialize ras recovery! (<span class="hljs-number">-5</span>)<br>            --&gt; amdgpu_amdkfd_device_init()<br>                --&gt; kgd2kfd_device_init()<br>                    [<span class="hljs-number">22907.144489</span>] kfd kfd: amdgpu: Allocated <span class="hljs-number">3969056</span> bytes on gart<br>                    --&gt; kfd_gtt_sa_init()<br>                        [<span class="hljs-number">22907.144490</span>] [<span class="hljs-number">244191</span>] amdgpu: gtt_sa_num_of_chunks = <span class="hljs-number">7752</span>, gtt_sa_bitmap = <span class="hljs-number">000000005240393f</span><br>                    --&gt; kfd_doorbell_init()<br>                        [<span class="hljs-number">22907.144498</span>] [<span class="hljs-number">244191</span>] amdgpu: Doorbell initialization:<br>                        [<span class="hljs-number">22907.144499</span>] [<span class="hljs-number">244191</span>] amdgpu: doorbell base           == <span class="hljs-number">0x2200002000</span><br>                        [<span class="hljs-number">22907.144499</span>] [<span class="hljs-number">244191</span>] amdgpu: doorbell_base_dw_offset      == <span class="hljs-number">0x00000800</span><br>                        [<span class="hljs-number">22907.144499</span>] [<span class="hljs-number">244191</span>] amdgpu: doorbell_process_limit  == <span class="hljs-number">0x000000FF</span><br>                        [<span class="hljs-number">22907.144500</span>] [<span class="hljs-number">244191</span>] amdgpu: doorbell_kernel_offset  == <span class="hljs-number">0x2200002000</span><br>                        [<span class="hljs-number">22907.144500</span>] [<span class="hljs-number">244191</span>] amdgpu: doorbell aperture size  == <span class="hljs-number">0x00200000</span><br>                        [<span class="hljs-number">22907.144501</span>] [<span class="hljs-number">244191</span>] amdgpu: doorbell kernel address == <span class="hljs-number">00000000</span>ec5ee4d9<br>                    --&gt; device_queue_manager_init()<br>                        [<span class="hljs-number">22907.144543</span>] [<span class="hljs-number">244191</span>] amdgpu: Loading device <span class="hljs-built_in">queue</span> manager<br>                        --&gt; initialize_nocpsch()/initialize_cpsch()<br>                            [<span class="hljs-number">22907.144638</span>] [<span class="hljs-number">244191</span>] amdgpu: num of pipes: <span class="hljs-number">4</span><br>                            --&gt; init_sdma_bitmaps()<br>                                [<span class="hljs-number">22907.144638</span>] amdgpu: sdma_bitmap: ffff<br>                        --&gt; init_mqd_managers()<br>                            --&gt; asic_ops-&gt;mqd_manager_init = mqd_manager_init_v9()<br>                                mqd_manager_init_v9()<br>                                    mqd-&gt;load_mqd = kfd_hiq_load_mqd_kiq;<br>                                    kfd_hiq_load_mqd_kiq()<br>                                        gfx_v9_kfd2kgd.hiq_mqd_load = kgd_gfx_v9_hiq_mqd_load()<br>                        --&gt; dqm-&gt;ops.create_queue = create_queue_nocpsch;<br>                        --&gt; dqm-&gt;ops.start = start_cpsch;<br>                    --&gt; kfd_resume(kfd)<br>                        --&gt; kfd-&gt;dqm-&gt;ops.start(kfd-&gt;dqm)<br>                            <span class="hljs-comment">// dqm-&gt;ops.start = start_cpsch;</span><br>                            start_cpsch()<br>                            --&gt; pm_init()<br>                                --&gt; kernel_queue_init()<br>                                    --&gt; kq_initialize()<br>                                        [<span class="hljs-number">22907.144642</span>] [<span class="hljs-number">244191</span>] amdgpu: Initializing <span class="hljs-built_in">queue</span> type <span class="hljs-number">2</span> size <span class="hljs-number">2048</span><br>                                        --&gt; kfd_get_kernel_doorbell()<br>                                            [<span class="hljs-number">22907.144642</span>] [<span class="hljs-number">244191</span>] amdgpu: Get kernel <span class="hljs-built_in">queue</span> doorbell<br>                                                                doorbell offset   == <span class="hljs-number">0x00000800</span><br>                                                                doorbell index    == <span class="hljs-number">0x0</span><br>                                        --&gt; kfd_gtt_sa_allocate() * <span class="hljs-number">4</span><br>                                            [<span class="hljs-number">22907.144643</span>] [<span class="hljs-number">244191</span>] amdgpu: Allocated mem_obj = <span class="hljs-number">00000000</span>c6362840 <span class="hljs-keyword">for</span> size = <span class="hljs-number">2048</span><br>                                            [<span class="hljs-number">22907.144644</span>] [<span class="hljs-number">244191</span>] amdgpu: Found = <span class="hljs-number">0</span><br>                                            [<span class="hljs-number">22907.144644</span>] [<span class="hljs-number">244191</span>] amdgpu: gpu_addr = <span class="hljs-number">00000000</span>ef7ebed7, cpu_addr = <span class="hljs-number">0000000052309</span>c93<br>                                            [<span class="hljs-number">22907.144645</span>] [<span class="hljs-number">244191</span>] amdgpu: range_start = <span class="hljs-number">0</span>, range_end = <span class="hljs-number">3</span><br>                                            [<span class="hljs-number">22907.144645</span>] [<span class="hljs-number">244191</span>] amdgpu: Allocated mem_obj = <span class="hljs-number">000000007</span>ae05bdc <span class="hljs-keyword">for</span> size = <span class="hljs-number">4096</span><br>                                            [<span class="hljs-number">22907.144646</span>] [<span class="hljs-number">244191</span>] amdgpu: Found = <span class="hljs-number">4</span><br>                                            [<span class="hljs-number">22907.144646</span>] [<span class="hljs-number">244191</span>] amdgpu: gpu_addr = <span class="hljs-number">000000008</span>cbe4b16, cpu_addr = <span class="hljs-number">000000008</span>ec6d2d0<br>                                            [<span class="hljs-number">22907.144647</span>] [<span class="hljs-number">244191</span>] amdgpu: range_start = <span class="hljs-number">4</span>, range_end = <span class="hljs-number">11</span><br>                                            [<span class="hljs-number">22907.144647</span>] [<span class="hljs-number">244191</span>] amdgpu: Allocated mem_obj = <span class="hljs-number">000000001</span>c98cd7f <span class="hljs-keyword">for</span> size = <span class="hljs-number">4</span><br>                                            [<span class="hljs-number">22907.144648</span>] [<span class="hljs-number">244191</span>] amdgpu: Found = <span class="hljs-number">12</span><br>                                            [<span class="hljs-number">22907.144648</span>] [<span class="hljs-number">244191</span>] amdgpu: gpu_addr = <span class="hljs-number">00000000f</span>dd101a7, cpu_addr = <span class="hljs-number">00000000704</span>ebcb5<br>                                            [<span class="hljs-number">22907.144648</span>] [<span class="hljs-number">244191</span>] amdgpu: Single bit<br>                                            [<span class="hljs-number">22907.144649</span>] [<span class="hljs-number">244191</span>] amdgpu: Allocated mem_obj = <span class="hljs-number">0000000023</span>ca5260 <span class="hljs-keyword">for</span> size = <span class="hljs-number">8</span><br>                                            [<span class="hljs-number">22907.144649</span>] [<span class="hljs-number">244191</span>] amdgpu: Found = <span class="hljs-number">13</span><br>                                            [<span class="hljs-number">22907.144650</span>] [<span class="hljs-number">244191</span>] amdgpu: gpu_addr = <span class="hljs-number">0000000076</span>cf5431, cpu_addr = <span class="hljs-number">0000000034</span>d2bd4c<br>                                            [<span class="hljs-number">22907.144650</span>] [<span class="hljs-number">244191</span>] amdgpu: Single bit<br>                                        --&gt; <span class="hljs-keyword">if</span> (init_queue(&amp;kq-&gt;<span class="hljs-built_in">queue</span>, &amp;prop) != <span class="hljs-number">0</span>)<br>                                        <span class="hljs-comment">// update_mqd()</span><br>                                        <span class="hljs-comment">// [22907.144651] [244191] amdgpu: cp_hqd_pq_control 0x508</span><br>                                        <span class="hljs-comment">// restore_mqd()</span><br>                                        <span class="hljs-comment">// [22907.144652] [244191] amdgpu: cp_hqd_pq_doorbell_control 0x2000</span><br>                                        [<span class="hljs-number">22907.144652</span>] [<span class="hljs-number">244191</span>] amdgpu: Assigning hiq to hqd<br>                                        --&gt; kq-&gt;mqd_mgr-&gt;load_mqd(kq-&gt;mqd_mgr, kq-&gt;<span class="hljs-built_in">queue</span>-&gt;mqd, kq-&gt;<span class="hljs-built_in">queue</span>-&gt;pipe, kq-&gt;<span class="hljs-built_in">queue</span>-&gt;<span class="hljs-built_in">queue</span>, &amp;kq-&gt;<span class="hljs-built_in">queue</span>-&gt;properties, <span class="hljs-literal">NULL</span>);<br>                                            <span class="hljs-comment">// mqd-&gt;load_mqd = kfd_hiq_load_mqd_kiq;</span><br>                                            --&gt; <span class="hljs-keyword">return</span> mm-&gt;dev-&gt;kfd2kgd-&gt;hiq_mqd_load(mm-&gt;dev-&gt;adev, mqd, pipe_id,<br>                                                                queue_id, p-&gt;doorbell_off);<br>                                                <span class="hljs-comment">// gfx_v9_kfd2kgd.hiq_mqd_load = kgd_gfx_v9_hiq_mqd_load()</span><br>                                                kgd_gfx_v9_hiq_mqd_load()<br>                                                [<span class="hljs-number">22907.144654</span>] [<span class="hljs-number">244191</span>] amdgpu: kfd: <span class="hljs-built_in">set</span> HIQ, mec:<span class="hljs-number">2</span>, pipe:<span class="hljs-number">0</span>, <span class="hljs-built_in">queue</span>:<span class="hljs-number">0.</span><br>                                                --&gt; amdgpu_ring_write(kiq_ring, PACKET3(PACKET3_MAP_QUEUES, <span class="hljs-number">5</span>));<br>                                                --&gt; amdgpu_ring_write(kiq_ring,<br>                                                            PACKET3_MAP_QUEUES_QUEUE_SEL(<span class="hljs-number">0</span>) | <span class="hljs-comment">/* Queue_Sel */</span><br>                                                            PACKET3_MAP_QUEUES_VMID(m-&gt;cp_hqd_vmid) | <span class="hljs-comment">/* VMID */</span><br>                                                            PACKET3_MAP_QUEUES_QUEUE(queue_id) |<br>                                                            PACKET3_MAP_QUEUES_PIPE(pipe) |<br>                                                            PACKET3_MAP_QUEUES_ME((mec - <span class="hljs-number">1</span>)) |<br>                                                            PACKET3_MAP_QUEUES_QUEUE_TYPE(<span class="hljs-number">0</span>) | <span class="hljs-comment">/*queue_type: normal compute queue */</span><br>                                                            PACKET3_MAP_QUEUES_ALLOC_FORMAT(<span class="hljs-number">0</span>) | <span class="hljs-comment">/* alloc format: all_on_one_pipe */</span><br>                                                            PACKET3_MAP_QUEUES_ENGINE_SEL(<span class="hljs-number">1</span>) | <span class="hljs-comment">/* engine_sel: hiq */</span><br>                                                            PACKET3_MAP_QUEUES_NUM_QUEUES(<span class="hljs-number">1</span>)); <span class="hljs-comment">/* num_queues: must be 1 */</span><br>                                                --&gt; amdgpu_ring_write(kiq_ring,<br>                                                            PACKET3_MAP_QUEUES_DOORBELL_OFFSET(doorbell_off));<br>                                                --&gt; amdgpu_ring_write(kiq_ring, m-&gt;cp_mqd_base_addr_lo);<br>                                                --&gt; amdgpu_ring_write(kiq_ring, m-&gt;cp_mqd_base_addr_hi);<br>                                                --&gt; amdgpu_ring_write(kiq_ring, m-&gt;cp_hqd_pq_wptr_poll_addr_lo);<br>                                                --&gt; amdgpu_ring_write(kiq_ring, m-&gt;cp_hqd_pq_wptr_poll_addr_hi);<br>                                                --&gt; amdgpu_ring_commit(kiq_ring);<br>                                        --&gt; print_queue()<br>                                            [<span class="hljs-number">22907.144655</span>] [<span class="hljs-number">244191</span>] amdgpu: Printing <span class="hljs-built_in">queue</span>:<br>                                            [<span class="hljs-number">22907.144656</span>] [<span class="hljs-number">244191</span>] amdgpu: Queue Type: <span class="hljs-number">2</span><br>                                            [<span class="hljs-number">22907.144656</span>] [<span class="hljs-number">244191</span>] amdgpu: Queue Size: <span class="hljs-number">2048</span><br>                                            [<span class="hljs-number">22907.144656</span>] [<span class="hljs-number">244191</span>] amdgpu: Queue percent: <span class="hljs-number">100</span><br>                                            [<span class="hljs-number">22907.144657</span>] [<span class="hljs-number">244191</span>] amdgpu: Queue Address: <span class="hljs-number">0xCD1000</span><br>                                            [<span class="hljs-number">22907.144657</span>] [<span class="hljs-number">244191</span>] amdgpu: Queue Id: <span class="hljs-number">0</span><br>                                            [<span class="hljs-number">22907.144658</span>] [<span class="hljs-number">244191</span>] amdgpu: Queue Process Vmid: <span class="hljs-number">0</span><br>                                            [<span class="hljs-number">22907.144658</span>] [<span class="hljs-number">244191</span>] amdgpu: Queue Read Pointer: <span class="hljs-number">0x0000000000cd2800</span><br>                                            [<span class="hljs-number">22907.144658</span>] [<span class="hljs-number">244191</span>] amdgpu: Queue Write Pointer: <span class="hljs-number">0x0000000000cd2a00</span><br>                                            [<span class="hljs-number">22907.144659</span>] [<span class="hljs-number">244191</span>] amdgpu: Queue Doorbell Pointer: <span class="hljs-number">0x00000000ec5ee4d9</span><br>                                            [<span class="hljs-number">22907.144659</span>] [<span class="hljs-number">244191</span>] amdgpu: Queue Doorbell Offset: <span class="hljs-number">2048</span><br>                                            [<span class="hljs-number">22907.144660</span>] [<span class="hljs-number">244191</span>] amdgpu: Queue MQD Address: <span class="hljs-number">0x000000009cf9a951</span><br>                                            [<span class="hljs-number">22907.144660</span>] [<span class="hljs-number">244191</span>] amdgpu: Queue MQD Gart: <span class="hljs-number">0x48F000</span><br>                                            [<span class="hljs-number">22907.144661</span>] [<span class="hljs-number">244191</span>] amdgpu: Queue Process Address: <span class="hljs-number">0xffffffffffffffea</span><br>                                            [<span class="hljs-number">22907.144661</span>] [<span class="hljs-number">244191</span>] amdgpu: Queue Device Address: <span class="hljs-number">0x00000000bf68ccc7</span><br> <br>                            --&gt; set_sched_resources()<br>                                [<span class="hljs-number">22907.144662</span>] [<span class="hljs-number">244191</span>] amdgpu: Scheduling resources:<br>                                            vmid mask: <span class="hljs-number">0</span>x    FF00<br>                                            <span class="hljs-built_in">queue</span> mask: <span class="hljs-number">0xFCFCFCFC</span><br>                                --&gt; pm_send_set_resources()<br>                                    --&gt; kq_acquire_packet_buffer()<br>                                        [<span class="hljs-number">22907.144663</span>] [<span class="hljs-number">244191</span>] amdgpu: rptr: <span class="hljs-number">0</span><br>                                        [<span class="hljs-number">22907.144663</span>] [<span class="hljs-number">244191</span>] amdgpu: wptr: <span class="hljs-number">0</span><br>                                        [<span class="hljs-number">22907.144664</span>] [<span class="hljs-number">244191</span>] amdgpu: queue_address <span class="hljs-number">0x0000000052309c93</span><br>                                    --&gt; kq_submit_packet()<br>                                        --&gt; write_kernel_doorbell()<br>                                            [<span class="hljs-number">22907.144665</span>] [<span class="hljs-number">244191</span>] amdgpu: writing <span class="hljs-number">8</span> to doorbell address <span class="hljs-number">00000000</span>ec5ee4d9<br>                            [<span class="hljs-number">22907.144665</span>] [<span class="hljs-number">244191</span>] amdgpu: Allocating fence memory<br> <br>                        --&gt; kfd_gtt_sa_allocate()<br>                            [<span class="hljs-number">22907.144666</span>] [<span class="hljs-number">244191</span>] amdgpu: Allocated mem_obj = <span class="hljs-number">00000000f</span>2493a7d <span class="hljs-keyword">for</span> size = <span class="hljs-number">8</span><br>                            [<span class="hljs-number">22907.144666</span>] [<span class="hljs-number">244191</span>] amdgpu: Found = <span class="hljs-number">14</span><br>                            [<span class="hljs-number">22907.144666</span>] [<span class="hljs-number">244191</span>] amdgpu: gpu_addr = <span class="hljs-number">000000008e289627</span>, cpu_addr = <span class="hljs-number">00000000</span>d0a54834<br>                            [<span class="hljs-number">22907.144667</span>] [<span class="hljs-number">244191</span>] amdgpu: Single bit<br> <br>                    --&gt; amdgpu_amdkfd_get_local_mem_info()<br>                        [<span class="hljs-number">22907.144668</span>] [<span class="hljs-number">244191</span>] amdgpu: Address base: <span class="hljs-number">0x0000002400000000</span> public <span class="hljs-number">0x3ff000000</span> private <span class="hljs-number">0x0</span><br>                    --&gt; kfd_topology_add_device()<br>                        [<span class="hljs-number">22907.144679</span>] [<span class="hljs-number">244191</span>] amdgpu: Adding new GPU (ID: <span class="hljs-number">0x44d3</span>) to topology<br>                        --&gt; kfd_create_crat_image_virtual()<br>                            --&gt; kfd_create_vcrat_image_gpu()<br>                                --&gt; kfd_fill_gpu_memory_affinity()<br>                                    [<span class="hljs-number">22907.144681</span>] [<span class="hljs-number">244191</span>] amdgpu: Fill gpu memory affinity - type <span class="hljs-number">0x1</span> size <span class="hljs-number">0x3ff000000</span><br>                                --&gt; kfd_fill_gpu_direct_io_link_to_cpu()<br>                                    --&gt; kfd_find_numa_node_in_srat()<br>                                        [<span class="hljs-number">22907.144683</span>] amdgpu: SRAT table not found<br>                                [<span class="hljs-number">22907.144683</span>] amdgpu: Virtual CRAT table created <span class="hljs-keyword">for</span> GPU<br>                        --&gt; kfd_parse_crat_table()<br>                            [<span class="hljs-number">22907.144684</span>] [<span class="hljs-number">244191</span>] amdgpu: Parsing CRAT table with <span class="hljs-number">1</span> nodes<br>                            --&gt; kfd_parse_subtype()<br>                                --&gt; kfd_parse_subtype_cu()<br>                                    [<span class="hljs-number">22907.144685</span>] [<span class="hljs-number">244191</span>] amdgpu: Found CU entry in CRAT table with proximity_domain=<span class="hljs-number">1</span> caps=<span class="hljs-number">0</span><br>                                    --&gt; kfd_populated_cu_info_gpu()<br>                                        [<span class="hljs-number">22907.144685</span>] [<span class="hljs-number">244191</span>] amdgpu: CU GPU: id_base=<span class="hljs-number">-2147479552</span><br>                                --&gt; kfd_parse_subtype_mem()<br>                                    [<span class="hljs-number">22907.144685</span>] [<span class="hljs-number">244191</span>] amdgpu: Found memory entry in CRAT table with proximity_domain=<span class="hljs-number">1</span><br>                                --&gt; kfd_parse_subtype_iolink()<br>                                    [<span class="hljs-number">22907.144686</span>] [<span class="hljs-number">244191</span>] amdgpu: Found IO link entry in CRAT table with id_from=<span class="hljs-number">1</span>, id_to <span class="hljs-number">0</span><br>                        --&gt; kfd_fill_cache_non_crat_info()<br>                            [<span class="hljs-number">22907.144696</span>] [<span class="hljs-number">244191</span>] amdgpu: Added [<span class="hljs-number">109</span>] GPU cache entries<br>                        --&gt; kfd_fill_mem_clk_max_info()<br>                            --&gt; amdgpu_amdkfd_get_local_mem_info()<br>                                [<span class="hljs-number">22907.144790</span>] [<span class="hljs-number">244191</span>] amdgpu: Address base: <span class="hljs-number">0x0000002400000000</span> public <span class="hljs-number">0x3ff000000</span> private <span class="hljs-number">0x0</span><br>                        --&gt; kfd_debug_print_topology()<br>                            [<span class="hljs-number">22907.144800</span>] amdgpu: Topology: Add dGPU node [<span class="hljs-number">0x66af</span>:<span class="hljs-number">0x1002</span>]<br>                    [<span class="hljs-number">22907.144801</span>] kfd kfd: amdgpu: added device <span class="hljs-number">1002</span>:<span class="hljs-number">66</span>af<br>                    [<span class="hljs-number">22907.144801</span>] [<span class="hljs-number">244191</span>] amdgpu: Starting kfd with the following scheduling policy <span class="hljs-number">0</span><br>        [<span class="hljs-number">22907.144811</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: SE <span class="hljs-number">4</span>, SH per SE <span class="hljs-number">1</span>, CU per SH <span class="hljs-number">16</span>, active_cu_number <span class="hljs-number">60</span><br>        --&gt; amdgpu_device_ip_late_init()<br>                adev-&gt;ip_blocks[i].version-&gt;funcs-&gt;late_init<br>                gmc_v9_0_ip_funcs.late_init() = gmc_v9_0_late_init<br>                gmc_v9_0_late_init()<br>                --&gt; amdgpu_gmc_allocate_vm_inv_eng()<br>                    [<span class="hljs-number">22907.144863</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring gfx uses VM inv eng <span class="hljs-number">0</span> on hub <span class="hljs-number">0</span><br>                    [<span class="hljs-number">22907.144864</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring comp_1<span class="hljs-number">.0</span><span class="hljs-number">.0</span> uses VM inv eng <span class="hljs-number">1</span> on hub <span class="hljs-number">0</span><br>                    [<span class="hljs-number">22907.144864</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring comp_1<span class="hljs-number">.1</span><span class="hljs-number">.0</span> uses VM inv eng <span class="hljs-number">4</span> on hub <span class="hljs-number">0</span><br>                    [<span class="hljs-number">22907.144865</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring comp_1<span class="hljs-number">.2</span><span class="hljs-number">.0</span> uses VM inv eng <span class="hljs-number">5</span> on hub <span class="hljs-number">0</span><br>                    [<span class="hljs-number">22907.144865</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring comp_1<span class="hljs-number">.3</span><span class="hljs-number">.0</span> uses VM inv eng <span class="hljs-number">6</span> on hub <span class="hljs-number">0</span><br>                    [<span class="hljs-number">22907.144866</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring comp_1<span class="hljs-number">.0</span><span class="hljs-number">.1</span> uses VM inv eng <span class="hljs-number">7</span> on hub <span class="hljs-number">0</span><br>                    [<span class="hljs-number">22907.144866</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring comp_1<span class="hljs-number">.1</span><span class="hljs-number">.1</span> uses VM inv eng <span class="hljs-number">8</span> on hub <span class="hljs-number">0</span><br>                    [<span class="hljs-number">22907.144867</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring comp_1<span class="hljs-number">.2</span><span class="hljs-number">.1</span> uses VM inv eng <span class="hljs-number">9</span> on hub <span class="hljs-number">0</span><br>                    [<span class="hljs-number">22907.144867</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring comp_1<span class="hljs-number">.3</span><span class="hljs-number">.1</span> uses VM inv eng <span class="hljs-number">10</span> on hub <span class="hljs-number">0</span><br>                    [<span class="hljs-number">22907.144868</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring kiq_2<span class="hljs-number">.1</span><span class="hljs-number">.0</span> uses VM inv eng <span class="hljs-number">11</span> on hub <span class="hljs-number">0</span><br>                    [<span class="hljs-number">22907.144868</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring sdma0 uses VM inv eng <span class="hljs-number">0</span> on hub <span class="hljs-number">1</span><br>                    [<span class="hljs-number">22907.144868</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring page0 uses VM inv eng <span class="hljs-number">1</span> on hub <span class="hljs-number">1</span><br>                    [<span class="hljs-number">22907.144869</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring sdma1 uses VM inv eng <span class="hljs-number">4</span> on hub <span class="hljs-number">1</span><br>                    [<span class="hljs-number">22907.144870</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring page1 uses VM inv eng <span class="hljs-number">5</span> on hub <span class="hljs-number">1</span><br>                    [<span class="hljs-number">22907.144870</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring uvd_0 uses VM inv eng <span class="hljs-number">6</span> on hub <span class="hljs-number">1</span><br>                    [<span class="hljs-number">22907.144870</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring uvd_enc_0<span class="hljs-number">.0</span> uses VM inv eng <span class="hljs-number">7</span> on hub <span class="hljs-number">1</span><br>                    [<span class="hljs-number">22907.144871</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring uvd_enc_0<span class="hljs-number">.1</span> uses VM inv eng <span class="hljs-number">8</span> on hub <span class="hljs-number">1</span><br>                    [<span class="hljs-number">22907.144871</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring uvd_1 uses VM inv eng <span class="hljs-number">9</span> on hub <span class="hljs-number">1</span><br>                    [<span class="hljs-number">22907.144872</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring uvd_enc_1<span class="hljs-number">.0</span> uses VM inv eng <span class="hljs-number">10</span> on hub <span class="hljs-number">1</span><br>                    [<span class="hljs-number">22907.144872</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring uvd_enc_1<span class="hljs-number">.1</span> uses VM inv eng <span class="hljs-number">11</span> on hub <span class="hljs-number">1</span><br>                    [<span class="hljs-number">22907.144873</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring vce0 uses VM inv eng <span class="hljs-number">12</span> on hub <span class="hljs-number">1</span><br>                    [<span class="hljs-number">22907.144873</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring vce1 uses VM inv eng <span class="hljs-number">13</span> on hub <span class="hljs-number">1</span><br>                    [<span class="hljs-number">22907.144874</span>] amdgpu <span class="hljs-number">0000</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00.0</span>: amdgpu: ring vce2 uses VM inv eng <span class="hljs-number">14</span> on hub <span class="hljs-number">1</span><br> <br>        --&gt; amdgpu_pmu_init()<br>            --&gt; init_pmu_entry_by_type_and_add()<br>                [<span class="hljs-number">22907.151940</span>] amdgpu: Detected AMDGPU DF Counters. <span class="hljs-meta"># of Counters = 8.</span><br>                [<span class="hljs-number">22907.151950</span>] amdgpu: Detected AMDGPU <span class="hljs-number">2</span> Perf Events.<br><span class="hljs-comment">// [22907.152889] [drm] Initialized amdgpu 3.48.0 20150101 for 0000:03:00.0 on minor 1</span><br><span class="hljs-comment">// [22907.155820] [drm] Cannot find any crtc or sizes</span><br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>

<h2 id="队列创建"><a href="#队列创建" class="headerlink" title="队列创建"></a>队列创建</h2><details>
<summary>流程示意图</summary>

<pre><code class=" mermaid">flowchart TB
    subgraph kfdtest
        direction TB
        id0[&quot;HSAKMT_STATUS Create()&quot;] --&gt; id1[&quot;memset()&quot;] --&gt; id2[&quot;hsaKmtCreateQueue()
        
        Params:
        NodeId,
        type,
        DEFAULT_QUEUE_PERCENTAGE,
        DEFAULT_PRIORITY,
        m_QueueBuf-&gt;As&lt;unsigned int*&gt;(),
        m_QueueBuf-&gt;Size(),
        NULL,
        &amp;m_Resources&quot;]
    end

    subgraph Thunk
        direction TB
        id3[&quot;handle_concrete_asic();&quot;] --&gt; id4[&quot;args.read_pointer_address = QueueResource-&gt;QueueRptrValue;
            args.write_pointer_address = QueueResource-&gt;QueueWptrValue;
            args.ring_base_address = (uintptr_t)QueueAddress;
            args.ring_size = QueueSizeInBytes;
            args.queue_percentage = QueuePercentage;
            args.queue_priority = priority_map[Priority+3];&quot;] --&gt; id5[&quot;kmtIoctl(kfd_fd, AMDKFD_IOC_CREATE_QUEUE, &amp;args)&quot;]
    end

    subgraph Driver
        direction TB
        subgraph kfd_ioctl_create_queue
            direction TB
            set_queue_properties_from_user --&gt; kfd_process_device_data_by_id --&gt; kfd_bind_process_to_device --&gt; pqm_create_queue
            subgraph pqm_create_queue
                direction TB
                kfd_get_process_device_data --&gt; init_user_queue --&gt; kfd_process_drain_interrupts --&gt; create_queue --&gt; create_queue_cpsch
                subgraph create_queue_cpsch
                    direction TB
                    allocate_doorbell --&gt; init_mqd --&gt; list_add --&gt; increment_queue_count --&gt; execute_queues_cpsch --&gt; deallocate_doorbell
                end
            end
        end
    end

    kfdtest --&gt; Thunk
    Thunk --&gt; Driver
    style id2 text-align:left
    style id4 text-align:left
</code></pre>

</details>

<details>
<summary>execute_queues_cpsch 流程</summary>

<pre><code class=" mermaid">flowchart TB
    subgraph execute_queues_cpsch
        direction TB
        subgraph unmap_queues_cpsch
            direction TB
            pm_send_unmap_queue --&gt; pm_send_query_status --&gt; amdkfd_fence_wait_timeout --&gt; pm_release_ib
        end

        subgraph map_queues_cpsch
            direction TB
            subgraph pm_send_runlist
                direction TB
                pm_create_runlist_ib --&gt; kq_acquire_packet_buffer --&gt; pm_runlist_v9 --&gt; kq_submit_packet
            end
        end

        unmap_queues_cpsch --&gt; map_queues_cpsch
    end
</code></pre>

</details>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-9d3fcfc2" role="button" aria-expanded="false" aria-controls="collapse-9d3fcfc2">
        <div class="fold-arrow">▶</div>AMD GPU Queue create
      </div>
      <div class="fold-collapse collapse" id="collapse-9d3fcfc2">
        <div class="fold-content">
          <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ----------------------------------------------------------------------------------------------------------------------------------</span><br><span class="hljs-comment">//                            kfdtest</span><br><span class="hljs-comment">// ----------------------------------------------------------------------------------------------------------------------------------</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseQueue</span></span><br><span class="hljs-class">--&gt;</span> HSAKMT_STATUS <span class="hljs-title function_">Create</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> NodeId, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size = DEFAULT_QUEUE_SIZE, HSAuint64 *pointers = <span class="hljs-literal">NULL</span>)</span>;<br>    --&gt; <span class="hljs-built_in">memset</span>(&amp;m_Resources, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(m_Resources));<br>    --&gt; hsaKmtCreateQueue(NodeId, type, DEFAULT_QUEUE_PERCENTAGE, DEFAULT_PRIORITY, m_QueueBuf-&gt;As&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>*&gt;(), m_QueueBuf-&gt;Size(), <span class="hljs-literal">NULL</span>, &amp;m_Resources);<br><span class="hljs-comment">// ----------------------------------------------------------------------------------------------------------------------------------</span><br><span class="hljs-comment">//                            Thunk</span><br><span class="hljs-comment">// ----------------------------------------------------------------------------------------------------------------------------------</span><br>        --&gt; <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kfd_ioctl_create_queue_args</span> <span class="hljs-title">args</span> =</span> &#123;<span class="hljs-number">0</span>&#125;;<br>        --&gt; handle_concrete_asic(q, &amp;args, NodeId, Event, QueueResource-&gt;ErrorReason);<br>        --&gt; args.read_pointer_address = QueueResource-&gt;QueueRptrValue;<br>            args.write_pointer_address = QueueResource-&gt;QueueWptrValue;<br>            args.ring_base_address = (<span class="hljs-type">uintptr_t</span>)QueueAddress;<br>            args.ring_size = QueueSizeInBytes;<br>            args.queue_percentage = QueuePercentage;<br>            args.queue_priority = priority_map[Priority+<span class="hljs-number">3</span>];<br>        --&gt; err = kmtIoctl(kfd_fd, AMDKFD_IOC_CREATE_QUEUE, &amp;args);<br><span class="hljs-comment">// ----------------------------------------------------------------------------------------------------------------------------------</span><br><span class="hljs-comment">//                            Driver</span><br><span class="hljs-comment">// ----------------------------------------------------------------------------------------------------------------------------------</span><br>            --&gt; <span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kfd_ioctl_create_queue</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filep, <span class="hljs-keyword">struct</span> kfd_process *p, <span class="hljs-type">void</span> *data)</span><br>                --&gt; <span class="hljs-title function_">set_queue_properties_from_user</span><span class="hljs-params">(&amp;q_properties, args)</span>;<br>                    --&gt; q_properties-&gt;is_interop = <span class="hljs-literal">false</span>;<br>                        q_properties-&gt;is_gws = <span class="hljs-literal">false</span>;<br>                        q_properties-&gt;queue_percent = args-&gt;queue_percentage;<br>                        q_properties-&gt;priority = args-&gt;queue_priority;<br>                        q_properties-&gt;queue_address = args-&gt;ring_base_address;<br>                        q_properties-&gt;queue_size = args-&gt;ring_size;<br>                        q_properties-&gt;read_ptr = (<span class="hljs-type">uint32_t</span> *) args-&gt;read_pointer_address;<br>                        q_properties-&gt;write_ptr = (<span class="hljs-type">uint32_t</span> *) args-&gt;write_pointer_address;<br>                        q_properties-&gt;eop_ring_buffer_address = args-&gt;eop_buffer_address;<br>                        q_properties-&gt;eop_ring_buffer_size = args-&gt;eop_buffer_size;<br>                        q_properties-&gt;ctx_save_restore_area_address = args-&gt;ctx_save_restore_address;<br>                        q_properties-&gt;ctx_save_restore_area_size = args-&gt;ctx_save_restore_size;<br>                        q_properties-&gt;ctl_stack_size = args-&gt;ctl_stack_size;<br>                        <span class="hljs-comment">//...</span><br>                --&gt; kfd_process_device_data_by_id()<br>                --&gt; kfd_bind_process_to_device()<br>                --&gt; pqm_create_queue(&amp;p-&gt;pqm, dev, filep, &amp;q_properties, &amp;queue_id, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;doorbell_offset_in_process);<br>                    --&gt; <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kfd_process_device</span> *<span class="hljs-title">pdd</span> =</span> kfd_get_process_device_data()<br>                        <span class="hljs-comment">// PM4Queue.hpp: Type is  HSA_QUEUE_COMPUTE --&gt; KFD_IOC_QUEUE_TYPE_COMPUTE --&gt; KFD_QUEUE_TYPE_COMPUTE</span><br>                        <span class="hljs-comment">// SDMAQueue.hpp: Type is HSA_QUEUE_SDMA    --&gt; KFD_IOC_QUEUE_TYPE_SDMA    --&gt; KFD_QUEUE_TYPE_SDMA</span><br>                    --&gt; init_user_queue(pqm, dev, &amp;q, properties, f, *qid);<br>                    --&gt; kfd_process_drain_interrupts(pdd);<br>                    --&gt; retval = dev-&gt;dqm-&gt;ops.create_queue(dev-&gt;dqm, q, &amp;pdd-&gt;qpd, q_data, restore_mqd, restore_ctl_stack);<br>                        <span class="hljs-comment">// dqm-&gt;ops.create_queue = create_queue_cpsch;</span><br>                        --&gt; create_queue_cpsch()<br>                            --&gt; allocate_doorbell()<br>                            --&gt; mqd_mgr-&gt;init_mqd(mqd_mgr, &amp;q-&gt;mqd, q-&gt;mqd_mem_obj, &amp;q-&gt;gart_mqd_addr, &amp;q-&gt;properties);<br>                            --&gt; list_add(&amp;q-&gt;<span class="hljs-built_in">list</span>, &amp;qpd-&gt;queues_list);<br>                            --&gt; increment_queue_count(dqm, qpd, q);<br>                            --&gt; execute_queues_cpsch(dqm, KFD_UNMAP_QUEUES_FILTER_DYNAMIC_QUEUES, <span class="hljs-number">0</span>, USE_DEFAULT_GRACE_PERIOD);<br>                                --&gt; retval = unmap_queues_cpsch(dqm, filter, filter_param, grace_period, <span class="hljs-literal">false</span>);<br>                                    --&gt; retval = pm_send_unmap_queue(&amp;dqm-&gt;packet_mgr, filter, filter_param, reset);<br>                                    --&gt; pm_send_query_status(&amp;dqm-&gt;packet_mgr, dqm-&gt;fence_gpu_addr, KFD_FENCE_COMPLETED);<br>                                    --&gt; retval = amdkfd_fence_wait_timeout(dqm-&gt;fence_addr, KFD_FENCE_COMPLETED, queue_preemption_timeout_ms);<br>                                    --&gt; pm_release_ib(&amp;dqm-&gt;packet_mgr);<br>                                --&gt; map_queues_cpsch(dqm);<br>                                    --&gt; pm_send_runlist(&amp;dqm-&gt;packet_mgr, &amp;dqm-&gt;queues);<br>                                        --&gt; retval = pm_create_runlist_ib(pm, dqm_queues, &amp;rl_gpu_ib_addr, &amp;rl_ib_size);<br>                                        --&gt; retval = kq_acquire_packet_buffer(pm-&gt;priv_queue, ket_size_dwords, &amp;rl_buffer);<br>                                        --&gt; retval = pm-&gt;pmf-&gt;runlist(pm, rl_buffer, rl_gpu_ib_addr, rl_ib_size / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint32_t</span>), <span class="hljs-literal">false</span>);<br>                                            --&gt; pm_runlist_v9()<br>                                        --&gt; kq_submit_packet(pm-&gt;priv_queue);<br>                                            --&gt; write_kernel_doorbell()<br>                                                --&gt; writel(value, db);<br>                                                    --&gt; __io_bw();<br>                                                        __raw_writel((u32 __force)__cpu_to_le32(value), addr);<br>                                                        __io_aw();<br>                                    --&gt; dqm-&gt;active_runlist = <span class="hljs-literal">true</span>;<br>                            --&gt; deallocate_doorbell(qpd, q);<br> <br> <br><span class="hljs-comment">/** Ioctl table */</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">amdkfd_ioctl_desc</span> <span class="hljs-title">amdkfd_ioctls</span>[] =</span> &#123;<br>    <span class="hljs-comment">//...</span><br>    AMDKFD_IOCTL_DEF(AMDKFD_IOC_CREATE_QUEUE,<br>            kfd_ioctl_create_queue, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment">//...</span><br>&#125;<br> <br>amdgpu_amdkfd_device_init()<br>--&gt; adev-&gt;kfd.init_complete = kgd2kfd_device_init(adev-&gt;kfd.dev, adev_to_drm(adev), &amp;gpu_resources);<br>    --&gt; kfd-&gt;dqm = device_queue_manager_init(kfd);<br>        --&gt; <span class="hljs-keyword">case</span> KFD_SCHED_POLICY_HWS_NO_OVERSUBSCRIPTION:<br>                <span class="hljs-comment">/* initialize dqm for cp scheduling */</span><br>                dqm-&gt;ops.create_queue = create_queue_cpsch;<br>                dqm-&gt;ops.initialize = initialize_cpsch;<br>                dqm-&gt;ops.start = start_cpsch;<br>                dqm-&gt;ops.stop = stop_cpsch;<br>                dqm-&gt;ops.pre_reset = pre_reset;<br>                dqm-&gt;ops.destroy_queue = destroy_queue_cpsch;<br>                dqm-&gt;ops.update_queue = update_queue;<br>                dqm-&gt;ops.register_process = register_process;<br>                dqm-&gt;ops.unregister_process = unregister_process;<br>                dqm-&gt;ops.uninitialize = uninitialize;<br>                dqm-&gt;ops.create_kernel_queue = create_kernel_queue_cpsch;<br>                dqm-&gt;ops.destroy_kernel_queue = destroy_kernel_queue_cpsch;<br>                dqm-&gt;ops.set_cache_memory_policy = set_cache_memory_policy;<br>                dqm-&gt;ops.process_termination = process_termination_cpsch;<br>                dqm-&gt;ops.evict_process_queues = evict_process_queues_cpsch;<br>                dqm-&gt;ops.restore_process_queues = restore_process_queues_cpsch;<br>                dqm-&gt;ops.get_wave_state = get_wave_state;<br>                dqm-&gt;ops.reset_queues = reset_queues_cpsch;<br>                dqm-&gt;ops.get_queue_checkpoint_info = get_queue_checkpoint_info;<br>                dqm-&gt;ops.checkpoint_mqd = checkpoint_mqd;<br>                <span class="hljs-keyword">break</span>;<br>    --&gt; kfd_resume()<br>        --&gt; kfd-&gt;dqm-&gt;ops.start(kfd-&gt;dqm);<br>            --&gt; retval = pm_init(&amp;dqm-&gt;packet_mgr, dqm);<br>                --&gt; pm-&gt;priv_queue = kernel_queue_init(dqm-&gt;dev, KFD_QUEUE_TYPE_HIQ);<br>                    --&gt; kq_initialize(kq, dev, type, KFD_KERNEL_QUEUE_SIZE)<br>                        --&gt; kq-&gt;mqd_mgr-&gt;init_mqd(kq-&gt;mqd_mgr, &amp;kq-&gt;<span class="hljs-built_in">queue</span>-&gt;mqd,<br>                                                    kq-&gt;<span class="hljs-built_in">queue</span>-&gt;mqd_mem_obj,<br>                                                    &amp;kq-&gt;<span class="hljs-built_in">queue</span>-&gt;gart_mqd_addr,<br>                                                    &amp;kq-&gt;<span class="hljs-built_in">queue</span>-&gt;properties);<br>        --&gt; set_sched_resources(dqm)<br>            --&gt; <span class="hljs-keyword">return</span> pm_send_set_resources(&amp;dqm-&gt;packet_mgr, &amp;res);<br>                --&gt; retval = pm-&gt;pmf-&gt;set_resources(pm, buffer, res);<br>                    --&gt; pm_set_resources_v9()<br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>

<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2>
    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-8a164987" role="button" aria-expanded="false" aria-controls="collapse-8a164987">
        <div class="fold-arrow">▶</div>MEC firmware
      </div>
      <div class="fold-collapse collapse" id="collapse-8a164987">
        <div class="fold-content">
          <p>MEC，又称 Ucode，或者microcode，是 CP 的重要 firmware。</p><p>在AMD GPU的初始化过程中，CP（Command Processor）模块的初始化是一个关键步骤，它涉及加载和配置微代码（microcode）以支持指令调度、命令解析、DMA（Direct Memory Access）以及图形和计算任务的管理。以下是该流程的详细介绍，包括KMD（Kernel Mode Driver）如何将Ucode写入CP模块的步骤。</p><ol><li><p><strong>CP模块初始化概述</strong></p><p> CP模块是AMD GPU的一个重要组件，主要负责以下任务：</p><ul><li>管理和调度指令（包括图形和计算命令）</li><li>处理和解析命令流（Command Stream）</li><li>协调硬件调度单元（Hardware Scheduler）</li><li>管理上下文切换和线程预处理（Thread Preemption）</li></ul><p> 在初始化时，CP模块需要被配置好其微代码，以便正确解析和调度由内核驱动（KMD）或用户驱动（UMD）发送的指令流。</p></li><li><p><strong>微代码（Microcode）的作用</strong></p><p> 微代码是CP模块执行的固件程序，它定义了CP模块如何解释并调度各种图形和计算任务。微代码通常包含以下几类指令：</p><ul><li>图形指令解析和调度逻辑</li><li>计算指令和DMA传输的管理</li><li>上下文切换（Context Switching）和优先级调度策略</li></ul><p> 在KMD初始化CP时，通常会先通过驱动程序将微代码加载到GPU的内存中，然后通过特定寄存器配置微代码的执行位置。</p></li><li><p><strong>CP模块的初始化流程</strong><br> 以下是一个典型的AMD GPU CP模块初始化流程：</p><ol><li><p><strong>微代码加载</strong>：</p><ul><li>驱动程序会将微代码文件（例如<code>gfx_cp.bin</code>）加载到系统内存中。这个文件通常通过KMD或固件接口（Firmware Interface）进行获取，包含预编译好的指令集合。</li></ul></li><li><p><strong>微代码传输到GPU内存</strong>：</p><ul><li>驱动程序通过MMIO（Memory-Mapped I&#x2F;O）或PCIe访问机制，将微代码从系统内存传输到GPU的内存（通常是显存或CP模块本地存储器中）。</li></ul></li><li><p><strong>CP微代码配置</strong>：</p><ul><li>驱动程序通过配置CP的寄存器来指定微代码的位置和大小。例如，通过以下寄存器进行配置：<ul><li><strong>CP_MEC_ME1_UCODE_ADDR</strong>：指定CP微代码的加载地址。</li><li><strong>CP_MEC_ME1_UCODE_DATA</strong>：逐字节或逐段将微代码数据写入指定地址。</li></ul></li><li>在配置时，通常需要先指定微代码基地址（例如显存或本地寄存器的地址），然后循环地写入微代码内容。对于CP模块，微代码加载通常采用单字（32-bit）或双字（64-bit）方式。</li></ul></li><li><p><strong>微代码加载确认和校验</strong>：</p><ul><li>驱动程序在完成微代码写入后，会配置相关寄存器标志位以启动微代码。例如：<ul><li>设置 <strong>CP_MEC_CNTL</strong> 寄存器的启动位（start bit）来触发CP模块执行微代码。</li></ul></li><li>驱动程序会通过读取寄存器状态（如检查校验和寄存器）来确认微代码是否加载成功。</li></ul></li><li><p><strong>命令处理配置</strong>：</p><ul><li>一旦微代码被成功加载和校验，CP模块会被配置为接收和解析来自KMD的图形或计算命令流。此时，KMD会配置相应的调度策略和上下文切换策略。</li></ul></li></ol></li><li><p><strong>KMD如何写入微代码（Ucode）</strong><br> KMD（Kernel Mode Driver）在进行CP模块的微代码初始化时，会采用以下具体步骤：</p><ol><li><p><strong>获取微代码数据</strong>：</p><ul><li>从驱动中定义的静态数组（或从设备固件库中）获取微代码的数据。微代码通常以二进制格式存在于驱动程序中，文件名可能是 <code>gfx_cp.bin</code> 或者通过加载固件接口（Firmware Loader）动态获取。</li></ul></li><li><p><strong>设置CP微代码写入地址</strong>：</p><ul><li>配置 <code>CP_MEC_ME1_UCODE_ADDR</code> 或 <code>CP_ME_RAM_WADDR</code> 等寄存器，以指向CP模块内部RAM或GPU内存中微代码的目标写入地址。</li></ul></li><li><p><strong>逐字写入微代码数据</strong>：</p><ul><li>使用循环结构逐字（word by word）地将微代码数据写入 <code>CP_MEC_ME1_UCODE_DATA</code> 或 <code>CP_ME_RAM_DATA</code> 寄存器。每次写入后，地址指针会自动递增。</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; microcode_size; i++) &#123;<br>    WREG32(CP_ME_RAM_WADDR, i);  <span class="hljs-comment">// 设置CP RAM的写入地址</span><br>    WREG32(CP_ME_RAM_DATA, microcode_data[i]);  <span class="hljs-comment">// 写入微代码数据</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>启动微代码执行</strong>：</p><ul><li>配置 <code>CP_RB_CNTL</code> 或 <code>CP_MEC_CNTL</code> 寄存器，以启动CP模块开始执行微代码。</li></ul></li><li><p><strong>校验加载状态</strong>：</p><ul><li>驱动程序通过读取 <code>CP_ME_STATUS</code> 或类似的状态寄存器来确认微代码是否正确启动和执行。</li></ul></li></ol></li><li><p><strong>关键寄存器的说明</strong><br> 在CP模块微代码加载过程中，以下寄存器通常需要配置：</p><ul><li><strong>CP_ME_RAM_WADDR</strong>：指向微代码在CP模块中的起始地址。</li><li><strong>CP_ME_RAM_DATA</strong>：用来写入微代码的具体数据。</li><li><strong>CP_MEC_CNTL</strong>：控制CP模块的启动和停止。</li><li><strong>CP_RB_CNTL</strong>：用于配置Ring Buffer和命令调度策略。</li><li><strong>CP_MEC_ME1_UCODE_ADDR &#x2F; CP_MEC_ME1_UCODE_DATA</strong>：配置MEC（Micro Engine Controller）微代码的加载地址和数据。</li></ul></li></ol><p>AMD GPU的CP模块初始化涉及复杂的微代码加载和配置过程。KMD通常通过内核模式驱动程序将微代码从系统内存传输到GPU内存中，再通过配置相关寄存器来启动微代码的执行。正确的微代码加载和配置对于GPU指令解析和任务调度至关重要。在实际开发中，可以使用调试工具（如<code>amdgpu-pro</code>或<code>gdb</code>）来检查CP模块的寄存器状态，以确保微代码正确加载并成功运行。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">gfx_v9_0_early_init</span><span class="hljs-params">(<span class="hljs-type">void</span> *handle)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">amdgpu_device</span> *<span class="hljs-title">adev</span> =</span> (<span class="hljs-keyword">struct</span> amdgpu_device *)handle;<br><br>    adev-&gt;gfx.funcs = &amp;gfx_v9_0_gfx_funcs;<br><br>    adev-&gt;gfx.num_gfx_rings = GFX9_NUM_GFX_RINGS;<br>    adev-&gt;gfx.num_compute_rings = min(amdgpu_gfx_get_num_kcq(adev),<br>                    AMDGPU_MAX_COMPUTE_RINGS);<br>    gfx_v9_0_set_spm_funcs(adev);<br>    gfx_v9_0_set_kiq_pm4_funcs(adev);<br>    gfx_v9_0_set_ring_funcs(adev);<br>    gfx_v9_0_set_irq_funcs(adev);<br>    gfx_v9_0_set_gds_init(adev);<br>    gfx_v9_0_set_rlc_funcs(adev);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> HYGON_KMD_SUPPORT</span><br>    gfx_v9_0_set_rd_stream(adev);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">/* init rlcg reg access ctrl */</span><br>    gfx_v9_0_init_rlcg_reg_access_ctrl(adev);<br><br>    <span class="hljs-keyword">return</span> gfx_v9_0_init_microcode(adev);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">gfx_v9_0_init_microcode</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_device *adev)</span><br>&#123;<br>    <span class="hljs-type">char</span> ucode_prefix[<span class="hljs-number">30</span>];<br>    <span class="hljs-type">int</span> r;<br><br>    DRM_DEBUG(<span class="hljs-string">&quot;\n&quot;</span>);<br><br>    amdgpu_ucode_ip_version_decode(adev, GC_HWIP, ucode_prefix, <span class="hljs-keyword">sizeof</span>(ucode_prefix));<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> HYGON_KMD_VEGA20</span><br>    <span class="hljs-comment">/* No CPG in Arcturus */</span><br>    <span class="hljs-keyword">if</span> (adev-&gt;gfx.num_gfx_rings) &#123;<br>        r = gfx_v9_0_init_cp_gfx_microcode(adev, ucode_prefix);<br>        <span class="hljs-keyword">if</span> (r)<br>            <span class="hljs-keyword">return</span> r;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    r = gfx_v9_0_init_rlc_microcode(adev, ucode_prefix);<br>    <span class="hljs-keyword">if</span> (r)<br>        <span class="hljs-keyword">return</span> r;<br><br>    r = gfx_v9_0_init_cp_compute_microcode(adev, ucode_prefix);<br>    <span class="hljs-keyword">if</span> (r)<br>        <span class="hljs-keyword">return</span> r;<br><br>    <span class="hljs-keyword">return</span> r;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">gfx_v9_0_init_cp_compute_microcode</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_device *adev,</span><br><span class="hljs-params">                    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *chip_name)</span><br>    &#123;<br>    <span class="hljs-type">char</span> fw_name[<span class="hljs-number">30</span>];<br>    <span class="hljs-type">int</span> err;<br><br>    <span class="hljs-built_in">snprintf</span>(fw_name, <span class="hljs-keyword">sizeof</span>(fw_name), <span class="hljs-string">&quot;hydcu/%s_mec.bin&quot;</span>, chip_name);<br>    err = request_firmware(&amp;adev-&gt;gfx.mec_fw, fw_name, adev-&gt;dev);<br>    <span class="hljs-keyword">if</span> (err)<br>        <span class="hljs-keyword">goto</span> out;<br>    amdgpu_gfx_cp_init_microcode(adev, AMDGPU_UCODE_ID_CP_MEC1);<br>    amdgpu_gfx_cp_init_microcode(adev, AMDGPU_UCODE_ID_CP_MEC1_JT);<br><br>    <span class="hljs-keyword">if</span> (gfx_v9_0_load_mec2_fw_bin_support(adev)) &#123;<br>        <span class="hljs-built_in">snprintf</span>(fw_name, <span class="hljs-keyword">sizeof</span>(fw_name), <span class="hljs-string">&quot;hydcu/%s_mec2.bin&quot;</span>, chip_name);<br><br>        <span class="hljs-comment">/* ignore failures to load */</span><br>        err = amdgpu_ucode_request(adev, &amp;adev-&gt;gfx.mec2_fw, fw_name);<br>        <span class="hljs-keyword">if</span> (!err) &#123;<br>            amdgpu_gfx_cp_init_microcode(adev, AMDGPU_UCODE_ID_CP_MEC2);<br>            amdgpu_gfx_cp_init_microcode(adev, AMDGPU_UCODE_ID_CP_MEC2_JT);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            err = <span class="hljs-number">0</span>;<br>            amdgpu_ucode_release(&amp;adev-&gt;gfx.mec2_fw);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        adev-&gt;gfx.mec2_fw_version = adev-&gt;gfx.mec_fw_version;<br>        adev-&gt;gfx.mec2_feature_version = adev-&gt;gfx.mec_feature_version;<br>    &#125;<br><br><br>    gfx_v9_0_check_if_need_gfxoff(adev);<br>    gfx_v9_0_check_fw_write_wait(adev);<br><br>out:<br>    <span class="hljs-keyword">if</span> (err)<br>        amdgpu_ucode_release(&amp;adev-&gt;gfx.mec_fw);<br>    <span class="hljs-keyword">return</span> err;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">amdgpu_gfx_cp_init_microcode</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_device *adev,</span><br><span class="hljs-params">                <span class="hljs-type">uint32_t</span> ucode_id)</span><br>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gfx_firmware_header_v1_0</span> *<span class="hljs-title">cp_hdr</span>;</span><br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gfx_firmware_header_v2_0</span> *<span class="hljs-title">cp_hdr_v2_0</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">amdgpu_firmware_info</span> *<span class="hljs-title">info</span> =</span> <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">firmware</span> *<span class="hljs-title">ucode_fw</span>;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fw_size;<br><br>    <span class="hljs-keyword">switch</span> (ucode_id) &#123;<br><span class="hljs-comment">//</span><br>    <span class="hljs-keyword">case</span> AMDGPU_UCODE_ID_CP_MEC1:<br>        cp_hdr = (<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> gfx_firmware_header_v1_0 *)<br>            adev-&gt;gfx.mec_fw-&gt;data;<br>        adev-&gt;gfx.mec_fw_version =<br>            le32_to_cpu(cp_hdr-&gt;header.ucode_version);<br>        adev-&gt;gfx.mec_feature_version =<br>            le32_to_cpu(cp_hdr-&gt;ucode_feature_version);<br>        ucode_fw = adev-&gt;gfx.mec_fw;<br>        fw_size = le32_to_cpu(cp_hdr-&gt;header.ucode_size_bytes) -<br>            le32_to_cpu(cp_hdr-&gt;jt_size) * <span class="hljs-number">4</span>;<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> AMDGPU_UCODE_ID_CP_MEC1_JT:<br>        cp_hdr = (<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> gfx_firmware_header_v1_0 *)<br>            adev-&gt;gfx.mec_fw-&gt;data;<br>        ucode_fw = adev-&gt;gfx.mec_fw;<br>        fw_size = le32_to_cpu(cp_hdr-&gt;jt_size) * <span class="hljs-number">4</span>;<br>        <span class="hljs-keyword">break</span>;<br><span class="hljs-comment">//</span><br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (adev-&gt;firmware.load_type == AMDGPU_FW_LOAD_PSP) &#123;<br>        info = &amp;adev-&gt;firmware.ucode[ucode_id];<br>        info-&gt;ucode_id = ucode_id;<br>        info-&gt;fw = ucode_fw;<br>        adev-&gt;firmware.fw_size += ALIGN(fw_size, PAGE_SIZE);<br>    &#125;<br>&#125;<br><br>gfx_v9_0_hw_init() --&gt; gfx_v9_0_cp_resume() --&gt; gfx_v9_0_cp_compute_load_microcode();<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">gfx_v9_0_cp_compute_load_microcode</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_device *adev)</span><br>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gfx_firmware_header_v1_0</span> *<span class="hljs-title">mec_hdr</span>;</span><br>    <span class="hljs-type">const</span> __le32 *fw_data;<br>    <span class="hljs-type">unsigned</span> i;<br>    u32 tmp;<br><br>    <span class="hljs-keyword">if</span> (!adev-&gt;gfx.mec_fw)<br>        <span class="hljs-keyword">return</span> -EINVAL;<br><br>    gfx_v9_0_cp_compute_enable(adev, <span class="hljs-literal">false</span>);<br><br>    mec_hdr = (<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> gfx_firmware_header_v1_0 *)adev-&gt;gfx.mec_fw-&gt;data;<br>    amdgpu_ucode_print_gfx_hdr(&amp;mec_hdr-&gt;header);<br><br>    fw_data = (<span class="hljs-type">const</span> __le32 *)<br>        (adev-&gt;gfx.mec_fw-&gt;data +<br>        le32_to_cpu(mec_hdr-&gt;header.ucode_array_offset_bytes));<br>    tmp = <span class="hljs-number">0</span>;<br>    tmp = REG_SET_FIELD(tmp, CP_CPC_IC_BASE_CNTL, VMID, <span class="hljs-number">0</span>);<br>    tmp = REG_SET_FIELD(tmp, CP_CPC_IC_BASE_CNTL, CACHE_POLICY, <span class="hljs-number">0</span>);<br>    WREG32_SOC15(GC, <span class="hljs-number">0</span>, mmCP_CPC_IC_BASE_CNTL, tmp);<br><br>    WREG32_SOC15(GC, <span class="hljs-number">0</span>, mmCP_CPC_IC_BASE_LO,<br>        adev-&gt;gfx.mec.mec_fw_gpu_addr &amp; <span class="hljs-number">0xFFFFF000</span>);<br>    WREG32_SOC15(GC, <span class="hljs-number">0</span>, mmCP_CPC_IC_BASE_HI,<br>        upper_32_bits(adev-&gt;gfx.mec.mec_fw_gpu_addr));<br><br>    <span class="hljs-comment">/* MEC1 */</span><br>    WREG32_SOC15(GC, <span class="hljs-number">0</span>, mmCP_MEC_ME1_UCODE_ADDR,<br>            mec_hdr-&gt;jt_offset);<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; mec_hdr-&gt;jt_size; i++)<br>        WREG32_SOC15(GC, <span class="hljs-number">0</span>, mmCP_MEC_ME1_UCODE_DATA,<br>            le32_to_cpup(fw_data + mec_hdr-&gt;jt_offset + i));<br><br>    WREG32_SOC15(GC, <span class="hljs-number">0</span>, mmCP_MEC_ME1_UCODE_ADDR,<br>            adev-&gt;gfx.mec_fw_version);<br>    <span class="hljs-comment">/* Todo : Loading MEC2 firmware is only necessary if MEC2 should run different microcode than MEC1. */</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">gfx_v9_0_cp_compute_enable</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_device *adev, <span class="hljs-type">bool</span> enable)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (enable) &#123;<br>        WREG32_SOC15_RLC(GC, <span class="hljs-number">0</span>, mmCP_MEC_CNTL, <span class="hljs-number">0</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        WREG32_SOC15_RLC(GC, <span class="hljs-number">0</span>, mmCP_MEC_CNTL,<br>            (CP_MEC_CNTL__MEC_ME1_HALT_MASK | CP_MEC_CNTL__MEC_ME2_HALT_MASK));<br>        adev-&gt;gfx.kiq.ring.sched.ready = <span class="hljs-literal">false</span>;<br>    &#125;<br>    udelay(<span class="hljs-number">50</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>

<h2 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h2><p>常见概念介绍：</p>

    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-d3d58547" role="button" aria-expanded="false" aria-controls="collapse-d3d58547">
        <div class="fold-arrow">▶</div>GMC Global Memory Controller
      </div>
      <div class="fold-collapse collapse" id="collapse-d3d58547">
        <div class="fold-content">
          <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">amdgpu_gmc</span> &#123;</span><br>    <span class="hljs-comment">/* FB（帧缓冲区）的物理地址和大小（供 CPU 映射使用）。</span><br><span class="hljs-comment">     * 这与 `vram_start` 和 `vram_end` 字段不同，后者是 GPU 视角的地址，</span><br><span class="hljs-comment">     * 而 `aper_base` 是 CPU 视角的物理地址。</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">resource_size_t</span> aper_size;         <span class="hljs-comment">// FB 孔径的大小</span><br>    <span class="hljs-type">resource_size_t</span> aper_base;         <span class="hljs-comment">// FB 孔径的起始地址（CPU 视角）</span><br><br>    <span class="hljs-comment">/* 对于某些显存 &lt;= 32MB 的芯片，需要在 MC（内存控制器）中</span><br><span class="hljs-comment">     * 修改 VRAM 大小以适应帧缓冲区位置。</span><br><span class="hljs-comment">     */</span><br>    u64 mc_vram_size;                  <span class="hljs-comment">// 显存（VRAM）大小（MC 视角）</span><br>    u64 visible_vram_size;             <span class="hljs-comment">// CPU 可见的显存大小</span><br><br>    <span class="hljs-comment">/* AGP（加速图形端口）孔径的起始和结束地址（MC 地址空间中）。</span><br><span class="hljs-comment">     * 驱动程序通过设置 MC_VM_AGP_BOT/TOP 寄存器在 MC 地址空间中找到一个 AGP 区域。</span><br><span class="hljs-comment">     * 在 VMID0 上，逻辑地址等于 MC 地址。AGP 孔径映射到物理总线地址或 IOVA 地址。</span><br><span class="hljs-comment">     * AGP 主要用于模拟帧缓冲区或者作为系统内存中的页表（主要用于 APU）。</span><br><span class="hljs-comment">     */</span><br>    u64 agp_size;                      <span class="hljs-comment">// AGP 孔径大小</span><br>    u64 agp_start;                     <span class="hljs-comment">// AGP 孔径起始地址</span><br>    u64 agp_end;                       <span class="hljs-comment">// AGP 孔径结束地址</span><br><br>    <span class="hljs-comment">/* GART（图形地址重映射表）孔径的起始和结束地址（MC 地址空间中）。</span><br><span class="hljs-comment">     * 驱动程序通过设置 VM_CONTEXT0_PAGE_TABLE_START/END_ADDR 寄存器在 MC 地址空间中</span><br><span class="hljs-comment">     * 找到一个 GART 区域。对于 VMID0 的逻辑地址，在 GART 区域中的地址通过 GPU VM</span><br><span class="hljs-comment">     * 的 GART 页表转换，访问分页的系统内存。</span><br><span class="hljs-comment">     */</span><br>    u64 gart_size;                     <span class="hljs-comment">// GART 孔径大小</span><br>    u64 gart_start;                    <span class="hljs-comment">// GART 孔径起始地址</span><br>    u64 gart_end;                      <span class="hljs-comment">// GART 孔径结束地址</span><br><br>    <span class="hljs-comment">/* 当前 GPU 设备的帧缓冲区孔径。不同于 `fb_start`，</span><br><span class="hljs-comment">     * 该字段只表示本地 GPU 设备的孔径范围。</span><br><span class="hljs-comment">     * 如果驱动程序使用 FB 孔径访问显存，则 `fb_start` 从</span><br><span class="hljs-comment">     * MC_VM_FB_LOCATION_BASE 中获取（由 vbios 设置）。</span><br><span class="hljs-comment">     * 如果驱动程序使用 GART 表访问 VMID0 的帧缓冲区，</span><br><span class="hljs-comment">     * 驱动程序会在 VMID0 虚拟地址空间中找到一个 SYSVM 孔径，</span><br><span class="hljs-comment">     * 其中第一部分是显存，第二部分是 GART（映射到系统内存）。</span><br><span class="hljs-comment">    */</span><br>    u64 vram_start;                    <span class="hljs-comment">// 本地 GPU 显存孔径起始地址</span><br>    u64 vram_end;                      <span class="hljs-comment">// 本地 GPU 显存孔径结束地址</span><br><br>    <span class="hljs-comment">/* FB（帧缓冲区）区域。在单 GPU 配置中，它等同于本地显存区域。</span><br><span class="hljs-comment">     * 在 XGMI（多 GPU 集群）配置中，该区域覆盖同一集群中所有 GPU。</span><br><span class="hljs-comment">     * 集群中的每个 GPU 具有相同的 FB 视图，GPU0 的显存从偏移 (0 * 段大小) 开始，</span><br><span class="hljs-comment">     * GPU1 从偏移 (1 * 段大小) 开始，以此类推。</span><br><span class="hljs-comment">     */</span><br>    u64 fb_start;                      <span class="hljs-comment">// 帧缓冲区起始地址</span><br>    u64 fb_end;                        <span class="hljs-comment">// 帧缓冲区结束地址</span><br><br>    <span class="hljs-type">unsigned</span> vram_width;               <span class="hljs-comment">// 显存总线宽度（位宽）</span><br>    u64 real_vram_size;                <span class="hljs-comment">// 实际可用的显存大小</span><br>    <span class="hljs-type">int</span> vram_mtrr;                     <span class="hljs-comment">// MTRR（内存类型范围寄存器）设置</span><br>    u64 mc_mask;                       <span class="hljs-comment">// 内存控制器的地址掩码</span><br><br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">firmware</span> *<span class="hljs-title">fw</span>;</span>         <span class="hljs-comment">// MC 固件指针</span><br>    <span class="hljs-type">uint32_t</span> fw_version;               <span class="hljs-comment">// 固件版本号</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">amdgpu_irq_src</span> <span class="hljs-title">vm_fault</span>;</span>    <span class="hljs-comment">// 虚拟内存故障源</span><br>    <span class="hljs-type">uint32_t</span> vram_type;                <span class="hljs-comment">// 显存类型（GDDR5、HBM 等）</span><br>    <span class="hljs-type">uint8_t</span> vram_vendor;               <span class="hljs-comment">// 显存供应商（例如三星、海力士等）</span><br>    <span class="hljs-type">uint32_t</span> ecc_status;               <span class="hljs-comment">// ECC（错误纠正码）状态</span><br>    <span class="hljs-type">uint32_t</span> srbm_soft_reset;          <span class="hljs-comment">// SRBM（系统请求总线管理器）软复位寄存器</span><br>    <span class="hljs-type">bool</span> prt_warning;                  <span class="hljs-comment">// PRT（部分资源事务）警告标志</span><br><br>    <span class="hljs-type">uint32_t</span> sdpif_register;           <span class="hljs-comment">// SDPIF（串行数据处理接口）寄存器</span><br><br>    <span class="hljs-comment">/* 各种孔径（用于多 GPU 配置时的地址分配） */</span><br>    u64 shared_aperture_start;         <span class="hljs-comment">// 共享孔径起始地址</span><br>    u64 shared_aperture_end;           <span class="hljs-comment">// 共享孔径结束地址</span><br>    u64 private_aperture_start;        <span class="hljs-comment">// 私有孔径起始地址</span><br>    u64 private_aperture_end;          <span class="hljs-comment">// 私有孔径结束地址</span><br><br>    <span class="hljs-comment">/* 用于保护并发的无效化操作 */</span><br>    <span class="hljs-type">spinlock_t</span> invalidate_lock;        <span class="hljs-comment">// 自旋锁，保护并发内存无效化操作</span><br>    <span class="hljs-type">bool</span> translate_further;            <span class="hljs-comment">// 是否需要进一步地址转换</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kfd_vm_fault_info</span> *<span class="hljs-title">vm_fault_info</span>;</span>  <span class="hljs-comment">// 虚拟内存故障信息</span><br>    <span class="hljs-type">atomic_t</span> vm_fault_info_updated;           <span class="hljs-comment">// 故障信息更新标志</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">amdgpu_gmc_fault</span> <span class="hljs-title">fault_ring</span>[<span class="hljs-title">AMDGPU_GMC_FAULT_RING_SIZE</span>];</span>  <span class="hljs-comment">// 内存故障环形缓冲区</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>        <span class="hljs-type">uint64_t</span> idx:AMDGPU_GMC_FAULT_RING_ORDER;       <span class="hljs-comment">// 故障环形缓冲区索引</span><br>    &#125; fault_hash[AMDGPU_GMC_FAULT_HASH_SIZE];           <span class="hljs-comment">// 故障哈希表</span><br>    <span class="hljs-type">uint64_t</span> last_fault:AMDGPU_GMC_FAULT_RING_ORDER;    <span class="hljs-comment">// 上次内存故障索引</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> HYGON_KMD_SUPPORT</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">amdgpu_gmc_va_hash</span> <span class="hljs-title">va_hash_table</span>[<span class="hljs-title">MAX_VA_HASH_SIZE</span>];</span>  <span class="hljs-comment">// VA（虚拟地址）哈希表（Hygon 芯片支持）</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-type">bool</span> tmz_enabled;                           <span class="hljs-comment">// 是否启用 TMZ（受信内存区）</span><br><br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">amdgpu_gmc_funcs</span> *<span class="hljs-title">gmc_funcs</span>;</span>   <span class="hljs-comment">// GMC 功能函数指针</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">amdgpu_xgmi</span> <span class="hljs-title">xgmi</span>;</span>                    <span class="hljs-comment">// XGMI（GPU 互联）结构体</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">amdgpu_irq_src</span> <span class="hljs-title">ecc_irq</span>;</span>              <span class="hljs-comment">// ECC 中断源</span><br>    <span class="hljs-type">int</span> noretry;                                <span class="hljs-comment">// 重试机制控制</span><br><br>    <span class="hljs-type">uint32_t</span> vmid0_page_table_block_size;       <span class="hljs-comment">// VMID0 页表块大小</span><br>    <span class="hljs-type">uint32_t</span> vmid0_page_table_depth;            <span class="hljs-comment">// VMID0 页表深度</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">amdgpu_bo</span> *<span class="hljs-title">pdb0_bo</span>;</span>                  <span class="hljs-comment">// VMID0 的页目录基址块</span><br>    <span class="hljs-type">void</span> *ptr_pdb0;                             <span class="hljs-comment">// 页目录基址块的 CPU 映射地址</span><br><br>    u64 noretry_flags;                          <span class="hljs-comment">// 内存事务重试标志</span><br>&#125;;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * GPU 全局内存控制器（GMC）结构体、函数及辅助工具。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">amdgpu_gmc_funcs</span> &#123;</span><br>    <span class="hljs-comment">/* 通过 MMIO（内存映射 I/O）刷新 VM（虚拟内存） TLB（页表缓冲区） */</span><br>    <span class="hljs-type">void</span> (*flush_gpu_tlb)(<span class="hljs-keyword">struct</span> amdgpu_device *adev, <span class="hljs-type">uint32_t</span> vmid,<br>                <span class="hljs-type">uint32_t</span> vmhub, <span class="hljs-type">uint32_t</span> flush_type);<br><br>    <span class="hljs-comment">/* 通过 PASID（进程地址空间 ID）刷新 VM TLB */</span><br>    <span class="hljs-type">int</span> (*flush_gpu_tlb_pasid)(<span class="hljs-keyword">struct</span> amdgpu_device *adev, <span class="hljs-type">uint16_t</span> pasid,<br>                    <span class="hljs-type">uint32_t</span> flush_type, <span class="hljs-type">bool</span> all_hub);<br><br>    <span class="hljs-comment">/* 通过 GPU 指令环（ring buffer）刷新 VM TLB */</span><br>    <span class="hljs-type">uint64_t</span> (*emit_flush_gpu_tlb)(<span class="hljs-keyword">struct</span> amdgpu_ring *ring, <span class="hljs-type">unsigned</span> vmid,<br>                    <span class="hljs-type">uint64_t</span> pd_addr);<br><br>    <span class="hljs-comment">/* 修改 VMID（虚拟内存 ID）到 PASID（进程地址空间 ID）的映射关系 */</span><br>    <span class="hljs-type">void</span> (*emit_pasid_mapping)(<span class="hljs-keyword">struct</span> amdgpu_ring *ring, <span class="hljs-type">unsigned</span> vmid,<br>                <span class="hljs-type">unsigned</span> pasid);<br><br>    <span class="hljs-comment">/* 启用/禁用 PRT（部分资源事务）支持 */</span><br>    <span class="hljs-type">void</span> (*set_prt)(<span class="hljs-keyword">struct</span> amdgpu_device *adev, <span class="hljs-type">bool</span> enable);<br><br>    <span class="hljs-comment">/* 将内存类型（mtype）映射到硬件标志 */</span><br>    <span class="hljs-type">uint64_t</span> (*map_mtype)(<span class="hljs-keyword">struct</span> amdgpu_device *adev, <span class="hljs-type">uint32_t</span> flags);<br><br>    <span class="hljs-comment">/* 获取给定 MC（内存控制器）地址的页目录条目（PDE） */</span><br>    <span class="hljs-type">void</span> (*get_vm_pde)(<span class="hljs-keyword">struct</span> amdgpu_device *adev, <span class="hljs-type">int</span> level,<br>            u64 *dst, u64 *flags);<br><br>    <span class="hljs-comment">/* 获取用于 BO（缓冲对象）VA（虚拟地址）映射的 PTE（页表项）标志 */</span><br>    <span class="hljs-type">void</span> (*get_vm_pte)(<span class="hljs-keyword">struct</span> amdgpu_device *adev,<br>            <span class="hljs-keyword">struct</span> amdgpu_bo_va_mapping *mapping,<br>            <span class="hljs-type">uint64_t</span> *flags);<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>struct amdgpu_gmc</code> 是 AMDGPU 驱动中用于表示 AMD GPU 全局内存控制器（Global Memory Controller, GMC）配置的结构体。该结构体主要负责管理 GPU 内存的各种配置和状态，包括 VRAM（视频内存）、GART（图形地址重映射表）、AGP（加速图形端口）等。每个字段都有其特定用途，用于处理 GPU 内存分配、访问、和故障管理等任务。</p><ol><li><strong>内存孔径字段（Aperture Fields）:</strong><ul><li><strong>aper_base</strong> 和 <strong>aper_size</strong>：<ul><li>代表从 CPU 角度看到的帧缓冲区（Frame Buffer, FB）孔径的物理地址和大小。这与 GPU 视角的地址不同，后者由 <code>vram_start</code>&#x2F;<code>vram_end</code> 表示。</li></ul></li><li><strong>vram_start</strong> 和 <strong>vram_end</strong>：<ul><li>定义 GPU 本地 VRAM 的起始和结束地址。</li></ul></li><li><strong>fb_start</strong> 和 <strong>fb_end</strong>：<ul><li>描述 Frame Buffer 区域的起始和结束地址。在多 GPU 设置中（例如 XGMI 集群），该区域覆盖所有 GPU 的显存，每个 GPU 可能会有不同的偏移量。</li></ul></li><li><strong>agp_start、agp_end、agp_size</strong>：<ul><li>指定 AGP（加速图形端口）孔径，主要用于早期 GPU 或集成 APU 的内存访问。</li></ul></li><li><strong>gart_start、gart_end、gart_size</strong>：<ul><li>描述 GART（图形地址重映射表）孔径，用于访问分页的系统内存（例如在虚拟内存场景下）。</li></ul></li></ul></li><li><strong>内存大小和属性字段:</strong><ul><li><strong>mc_vram_size</strong>：<ul><li>指定从内存控制器（Memory Controller, MC）视角看到的 VRAM 大小。</li></ul></li><li><strong>visible_vram_size</strong>：<ul><li>定义 CPU 可见的 VRAM 大小，这可能小于或等于 <code>mc_vram_size</code>。</li></ul></li><li><strong>real_vram_size</strong>：<ul><li>表示 GPU 实际可用的 VRAM 总大小。</li></ul></li><li><strong>vram_width</strong>：<ul><li>表示 VRAM 的总宽度（位宽），影响显存带宽。</li></ul></li></ul></li><li><strong>故障处理（Fault Handling）字段:</strong><ul><li><strong>vm_fault</strong>：<ul><li>描述虚拟内存（VM）故障的来源。</li></ul></li><li><strong>vm_fault_info</strong> 和 <strong>vm_fault_info_updated</strong>：<ul><li>存储虚拟内存故障的详细信息，并跟踪故障信息的更新。</li></ul></li><li><strong>fault_ring</strong>：<ul><li>用于记录和处理 GPU 内存故障的环形缓冲区。</li></ul></li></ul></li><li><strong>孔径共享和地址转换字段:</strong><ul><li><strong>shared_aperture_start</strong> 和 <strong>shared_aperture_end</strong>：<ul><li>多设备共享的孔径范围，用于 XGMI 等多 GPU 互联场景。</li></ul></li><li><strong>private_aperture_start</strong> 和 <strong>private_aperture_end</strong>：<ul><li>该设备独有的孔径范围。</li></ul></li><li><strong>translate_further</strong>：<ul><li>布尔类型，指示地址转换是否需要进一步进行。</li></ul></li></ul></li><li><strong>固件和配置信息:</strong><ul><li><strong>fw</strong> 和 <strong>fw_version</strong>：<ul><li>指向 MC 固件和固件版本号。</li></ul></li><li><strong>ecc_status</strong>：<ul><li>记录 ECC（错误纠正码）状态，用于检查显存中是否发生了位错误。</li></ul></li><li><strong>tmz_enabled</strong>：<ul><li>指示是否启用了 TMZ（受信内存区），这是一种用于保护特定内存区域的安全功能。</li></ul></li></ul></li><li><strong>锁和同步字段:</strong><ul><li><strong>invalidate_lock</strong>：<ul><li>自旋锁，用于保护内存无效化操作的并发访问。</li></ul></li></ul></li><li><strong>页表配置字段:</strong><ul><li><strong>vmid0_page_table_block_size</strong> 和 <strong>vmid0_page_table_depth</strong>：<ul><li>VMID0 页表的配置设置，决定页表的粒度和深度。</li></ul></li></ul></li><li><strong>多 GPU 和互联支持字段:</strong><ul><li><strong>xgmi</strong>：<ul><li>表示 XGMI（高速 GPU 互联）结构体，用于管理多 GPU 的互联配置和状态。</li></ul></li></ul></li><li><strong>其他字段:</strong><ul><li><strong>sdpif_register</strong>：<ul><li>SDPIF（串行数据处理接口）寄存器，用于与其他组件通信。</li></ul></li><li><strong>noretry</strong> 和 <strong>noretry_flags</strong>：<ul><li>内存事务重试机制的控制字段。</li></ul></li></ul></li></ol><p><code>amdgpu_gmc</code> 结构体被设计用于详细描述 AMD GPU 内存的各个部分，包括显存、系统内存和地址重映射表的配置。它可以管理不同 GPU 之间的内存地址空间，并为不同内存类型分配特定的地址范围。此外，它还包含故障处理字段以记录内存访问错误，并且支持多 GPU 的内存地址转换和互联配置。这些字段确保 GPU 内存管理的高效性和可靠性，是实现高性能计算和图形处理的基础。</p>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-7c6792e1" role="button" aria-expanded="false" aria-controls="collapse-7c6792e1">
        <div class="fold-arrow">▶</div>Direct Rendering Manager (DRM)
      </div>
      <div class="fold-collapse collapse" id="collapse-7c6792e1">
        <div class="fold-content">
          <p><strong>DRM</strong> 是 Linux 内核中的一个子系统，负责管理图形硬件设备。它为图形处理器（GPU）和显示设备提供低级别的图形资源管理和硬件加速支持。主要用于显示服务器（如 X11 或 Wayland）和图形库（如 Mesa 3D）与 GPU 之间的交互。</p><ol><li><strong>内存管理</strong>:<ul><li>DRM 管理 GPU 使用的显存（VRAM）和系统内存（GTT）。它处理内存的分配、映射和释放，确保 GPU 和 CPU 可以高效地共享和使用内存资源。</li></ul></li><li><strong>上下文管理</strong>:<ul><li>DRM 支持图形上下文的创建和管理，使多个图形应用程序可以同时运行并独立渲染其内容。这对于多任务处理和确保应用程序之间的隔离至关重要。</li></ul></li><li><strong>图形硬件控制</strong>:<ul><li>DRM 直接与图形硬件（如 GPU、显示控制器）交互，执行低级别操作，如显示模式设置（Mode Setting）、 Frame Buffer 管理（Framebuffer Management）、硬件加速命令的排队和执行等。</li></ul></li><li><strong>安全和访问控制</strong>:<ul><li>DRM 提供了对图形硬件的安全访问控制，确保只有授权的应用程序能够访问 GPU 资源。这在多用户环境中非常重要。</li></ul></li><li><strong>显示管理</strong>:<ul><li>DRM 包含了显示管理的功能，包括管理多个显示器、设置显示模式（分辨率、刷新率等）、处理热插拔事件等。它为图形栈中的更高级别组件（如 X Server 或 Wayland Compositor）提供了统一的接口。</li></ul></li></ol><p>DRM 的组件</p><ul><li><strong>DRM 驱动程序</strong>:<ul><li>这是特定于硬件的内核模块，负责与特定的 GPU 和显示硬件交互。每个支持 DRM 的 GPU 都有一个相应的 DRM 驱动程序，例如 <code>amdgpu</code>（AMD GPU）、<code>i915</code>（Intel GPU）、<code>nouveau</code>（NVIDIA 开源驱动）等。</li></ul></li><li><strong>GEM (Graphics Execution Manager)</strong>:<ul><li>这是 DRM 的一部分，负责内存对象的管理，特别是图形缓冲区的分配、映射和释放。</li></ul></li><li><strong>KMS (Kernel Mode Setting)</strong>:<ul><li>KMS 是 DRM 的一个子系统，用于在内核中设置显示模式（分辨率、颜色深度、刷新率等），而不是由用户空间应用程序设置。KMS 确保显示管理的安全性和稳定性，尤其是在多用户系统中。</li></ul></li></ul><p>DRM 的实际应用</p><p>在 Linux 系统中，DRM 是现代图形栈的核心组成部分。它提供了 GPU 资源的底层管理，支持 OpenGL、Vulkan 和其他图形 API 的硬件加速，确保图形应用程序能够高效运行。显示服务器如 X11 和 Wayland，图形库如 Mesa 3D，都依赖于 DRM 提供的功能来与 GPU 进行交互。</p>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-f1c92c02" role="button" aria-expanded="false" aria-controls="collapse-f1c92c02">
        <div class="fold-arrow">▶</div>TTM (Translation Table Manager)
      </div>
      <div class="fold-collapse collapse" id="collapse-f1c92c02">
        <div class="fold-content">
          <p>TTM 一个内存管理子系统，最初由 Tungsten Graphics 开发，目的是为 Linux 内核中的图形设备提供统一的内存管理。TTM 主要处理显存（VRAM）和系统内存（GART 或者系统RAM）之间的数据交换。它可以动态地管理和分配这些内存区域，支持显卡的高效使用。TTM 具有以下几个关键功能：</p><ul><li>内存管理：为图形硬件分配内存，支持在显存和系统内存之间的动态切换。</li><li>分页：在显存不足的情况下，TTM 允许将一些内存页面从显存转移到系统内存，从而腾出显存空间。</li><li>地址映射：通过使用页表和其他映射技术，TTM 可以将物理内存映射到 GPU 可访问的虚拟地址空间。</li></ul>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-715cf005" role="button" aria-expanded="false" aria-controls="collapse-715cf005">
        <div class="fold-arrow">▶</div>GEM (Graphics Execution Manager)
      </div>
      <div class="fold-collapse collapse" id="collapse-715cf005">
        <div class="fold-content">
          <p>GEM 是 Linux 内核中用于图形内存管理的一个框架，特别是用于与图形处理单元（GPU）交互。GEM 主要由 Intel 为其 i915 DRM 驱动程序开发，但后来被其他驱动程序采用或借鉴，用于管理 GPU 上的图形内存。</p><ol><li><strong>图形内存对象管理</strong>:<ul><li>GEM 负责分配、管理和释放 GPU 使用的图形内存对象。这些对象可以包括缓冲区（例如 Frame Buffer ）、纹理、顶点缓冲区等，这些都是 GPU 进行图形渲染的基础。</li></ul></li><li><strong>内存映射</strong>:<ul><li>GEM 允许用户空间程序将 GPU 内存映射到 CPU 地址空间。这意味着用户空间程序可以直接访问和修改 GPU 内存内容，例如更新纹理数据或将渲染结果从 GPU 传输回 CPU 进行后续处理。</li></ul></li><li><strong>同步与缓冲区共享</strong>:<ul><li>在一个系统中，多个进程或线程可能需要访问同一块 GPU 内存。GEM 提供了同步机制，确保这些访问是安全且有序的。</li><li>GEM 还允许共享缓冲区对象，这意味着不同的进程或 GPU 阶段可以共享和重用相同的图形内存对象，提高资源利用率和性能。</li></ul></li><li><strong>用户空间接口</strong>:<ul><li>GEM 提供了一组 ioctl（输入输出控制）接口，供用户空间程序调用。这些接口包括内存对象的创建、销毁、映射和同步操作等，使得用户空间程序能够与内核中的 GEM 模块交互，管理 GPU 内存。</li></ul></li><li><strong>调度与执行管理</strong>:<ul><li>GEM 在某些情况下也负责调度图形命令的执行，确保 GPU 可以高效地处理多个渲染任务。它通过管理图形命令流和确保内存对象的可用性来优化 GPU 的使用。</li></ul></li></ol><p>GEM 的引入极大地简化了 GPU 内存管理，使得图形应用程序可以更容易地管理 GPU 资源。通过提供一个通用的内存管理框架，GEM 使得不同的 GPU 驱动程序可以更一致地管理内存，减少了在不同硬件和驱动程序之间进行移植时的复杂性。在 Linux 内核中，除了 GEM 之外，还有其他用于 GPU 内存管理的机制，例如 <strong>TTM（Translation Table Maps）</strong>。TTM 是另一个内存管理框架，主要由 AMD 开发，并在一些开源驱动中使用。</p><ul><li><strong>GEM vs. TTM</strong>:<ul><li><strong>GEM</strong>：较简单，适用于较轻量级的图形内存管理任务，特别是在资源管理需求较低的环境中。</li><li><strong>TTM</strong>：更复杂，支持更高级的功能，如内存分页和交换，更适合需要大量内存管理的高性能图形应用程序。</li></ul></li></ul><p>一些 GPU 驱动程序可能会基于这两者的组合来实现最优的内存管理方案。</p>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-db7fe252" role="button" aria-expanded="false" aria-controls="collapse-db7fe252">
        <div class="fold-arrow">▶</div>PTE（Page Table Entry，页表项）和 PDE（Page Directory Entry，页目录项）
      </div>
      <div class="fold-collapse collapse" id="collapse-db7fe252">
        <div class="fold-content">
          <p>ROCm 中的 SVM 实现主要存在于 Thunk 中的用户模式下。分配内存时，Thunk 使用 mmap (…, PROT_NONE, …) 为内存分配虚拟地址空间。GPU 可以处理 48 位虚拟地址。缓冲区应映射到主机（如果它是主机可访问的缓冲区）和所有适用 GPU 上的该虚拟地址。</p><p>KFD 内存分配 ioctl 有一个用于虚拟地址的参数 <code>kfd_ioctl_alloc_memory_of_gpu_args.va_addr</code>。也就是说，Thunk 应该在要求 KFD 分配内存之前分配虚拟地址空间。KFD 在分配时将虚拟地址与内存关联起来。内存的未来映射应该使用该虚拟地址。如果适用，主机映射由 Thunk 使用 mmap(va_addr, …, MAP_FIXED, …) 完成，在第一个参数中指定先前分配的虚拟地址。</p><p>通过 ROCm API 分配的内存应映射到所有设备（主机和目标）上的相同虚拟地址。可以在设备上使用相同的指针来引用相同的内存。包含指针的数据结构可以在设备之间共享。</p><ul><li>MC 地址和 GPU 的物理地址：在为 GPU 编写驱动程序代码时，区分 MC（GPU 的内存控制器）和物理地址非常重要。GPU 物理地址从零开始，一直到最大视频内存大小。另一方面，MC 地址具有 48 位地址空间。内存孔径地址范围寄存器大多在 MC 地址空间中定义。通过定义这些寄存器的值，可以确定虚拟内存地址空间。<ul><li>F400000000 MC 地址在 VBIOS 中定义，当 GPU 自行启动时，应将该值写入寄存器 MC_VM_FB_LOCATION_BASE，驱动程序将该值读出为“系统定义值”，并且该值应该是预定义的。因此，该值不是 GPU 硬件中的硬编码值，您可以根据需要更改该值。</li><li>如何根据 MC 地址计算 GPU 的物理地址，可以按照以下公式计算物理地址：<strong>FB 的物理地址 &#x3D; (McAddr - ‘FB aperture start address’) + PHYS_FB_OFFSET</strong><ul><li>McAddr：在本例中为 MC 地址 F4_0000_0008。</li><li>FB aperture start address：由寄存器 MC_VM_FB_LOCATION_BASE 定义的 F4_0000_0000</li><li>PHYS_FB_OFFSET：它定义了 UMA 地址中视频内存的物理偏移量，因此在独立 GPU 中它应始终为 0。</li></ul></li><li>因此，您可以得到 (F4_0000_0008) 的物理地址为 (F4_0000_0008 – F4_0000_0000) + 0 &#x3D; 0x8</li></ul></li></ul><p>在填充页表的时候需要用到物理地址来组成PTE和PDE，所以了解如何计算物理地址很重要，但请注意有些寄存器是定义在MC地址中的，有些是定义在物理地址中的，不要混淆。</p><p>系统孔径（Aperture）：系统孔径由两部分组成， Frame Buffer 孔径和 AGP 孔径。大多数情况下，系统孔径与 Frame Buffer 孔径一致，即“本地 Frame Buffer ”或“视频内存”。孔径由两个寄存器“mmMC_VM_SYSTEM_APERTURE_LOW_ADDR”和“mmMC_VM_SYSTEM_APERTURE_HIGH_ADDR”定义。</p><p>MC 地址布局不是固定的，它实际上取决于使用情况和不同的平台。对于 Linux，地址布局有两个孔径，系统孔径和 Gart 孔径。</p><ul><li>系统孔径从 F400000000 开始，到视频内存的最大大小结束。</li><li>Gart 孔径目前定义在系统孔径之后，但同样，这不是硬件定义的值，您可以根据需要更改布局。您可以在“孔径”以外的任何地方定义，并且不要与其他孔径重叠。</li></ul><p>GPU MC 地址空间由两部分组成，高位部分（0xFFFF_8000_0000_0000, 0xFFFF_FFFF_FFFF_FFF），低位部分（0x0000_0000_0000_0000, 0x0000_7FFF_FFFF_FFFF），范围由 48 位地址空间第 47 位的有符号扩展定义，当第 47 位 &#x3D;&#x3D; 0 时，可以将 0 扩展至 64 位，并应获得低位部分的上限，当第 47 位 &#x3D;&#x3D; 1 时，可以将 1 扩展至 64 位，并应获得高位地址的下限。这两部分之间的地址称为“洞”，当 GPU 接收到洞内的任何地址时，它都是无效地址。</p><p>“Memory Address Space.xls”中引用了 Remote GPU FB 孔径，这是 VBIOS 和 SYSTEM BIOS 中额外支持在 gpu 中导出“Large-Bar”的，“Large-Bar”是指主机可以访问本地 Frame Buffer 的概念，这意味着 PCIE bar 空间是 64bit，系统可以分配一个覆盖本地 Frame Buffer 的地址空间。在这种模式下，GPU 可以通过 PCIE 相互访问，因为本地 Frame Buffer 对彼此是可见的。</p><p>GART 页表 在Linux开源驱动中，Gart表位于“可见内存”中。Gart表是一级页表。PAGE_TABLE_DEPTH定义为实际级别减一。</p><p>但有一个例外，这就是“LDS孔径”和“私有（临时）孔径”，有配置寄存器来指定这两个孔径，因此在计算着色器中，可以通过“FLAT*”指令访问这两个孔径。 分配给“LDS孔径”和“私有孔径”一部分的“洞”内的地址可以直接在“FLAT*”指令中使用，GPU可以通过该地址访问LDS或私有孔径。</p><p>GPUVM 使用模型 在 GPU 中，有 16 个称为 VMID 的 vm 域，VMID0 称为“系统域”，只有内核模式驱动程序可以使用 VMID0，它被配置为“gart 模型”，但其他 VMID 都暴露给用户模式驱动程序，从使用模型来看，VMID1 到 VMID15 是相等的。</p><p>虽然 GPU 是可配置的，但您可以为每个 VMID 分配不同的 vm 空间，但通常情况下，您会平等地配置其余 15 个 VMID。</p><p> Frame Buffer 用于显示，并且 gart 表必须在内部可见，固件则不是，固件应在驱动程序初始化 PSP 模块时上传到专用 ROM 上。 “VF 可见 Frame Buffer ”，VF 指的是虚拟功能，这是虚拟化中的一个概念。</p><p>“HDP”代表“主机数据路径”，它是主机在不知道 Frame Buffer 中实际内存布局的情况下访问 Frame Buffer 的方式。</p><p>VMID使用及分配策略 除0以外的VMID被视为平等，在开源linux驱动中，VMID1~VMID7分配给图形使用，VMID8~VMID15分配给计算使用，但这不是硬件限制，您可以重新定义使用。</p><p>页表级别也可以从1级到4级配置，所以也取决于使用情况，在Linux开源驱动中，您可以为每个VMID分配64GB的虚拟地址，因为如果覆盖太大的虚拟空间，页表将非常大，从而消耗视频内存。</p><p>所以，综上所述，VMID0是为启用GART表而设计的系统域，页表是一级，GART空间的大小是可配置的。 VMID1~VMID15 是用户模式虚拟机，每个虚拟机都有 64GB 的虚拟内存空间，同样，这是根据使用情况可配置的，gfx 驱动中是 64GB，但是 Rocm 驱动从 rocm 2.0 开始为用户启用了整个 48 位虚拟内存空间。用户模式驱动可以分配本地 Frame Buffer 或 gart 空间，更新到 PTE 中。</p><p>页表中有两种类型的块：</p><ul><li>页目录块 (PDB)</li><li>页表块 (PTB)</li></ul><p>在这些类型的块中，有两种类型的条目：</p><ul><li>PDB 中的页目录条目 (PDE)</li><li>PTB 中的页表条目 (PTE) 页表由一定数量的级别构成，最底层是页表块，其上每一级都是页目录块。</li></ul><p>PDB 由一组 64 位页面目录条目 (PDE) 组成。中间 PDB（不是最顶层的 PDB）最多应有 512 个 PDE；也就是说，它们最多占用单个对齐的 4kb 内存页面。最顶层的 PDB 可以小或大，以表示所需的虚拟地址空间；最顶层的 PDB 可以占用多个 4kb 内存页面，但组成页面必须相邻。每个 PDE 指向 8 个 PDE 或 8 个 PTE 的缓存行的物理基址，具体取决于其在页表层次结构中的位置。</p><p><img src="/img/gpu/amd/pte.png" srcset="/img/loading.gif" lazyload alt="PTE"></p><p>出于代码和寄存器文档命名目的，PDE 级别进一步描述如下：</p><ul><li>PDE0 - 指向 8 个 PTE 的起始缓存行</li><li>PDE1 - 指向 8 个 PDE0 的起始缓存行</li><li>PDE2 - 指向 8 个 PDE1 的起始缓存行</li></ul><p>64 位 PDE 的格式为：</p><p>关联页表块大小为 0 的传统页表块 (PTB) 包含 512 个 64 位页表条目 (PTE)，占用 4KB 内存空间。每个 PTE 指向一个 4KB 可寻址内存页，PTB 中的所有 512 个 PTE 共同寻址 2MB 内存空间（512 x 4KB &#x3D; 2MB）。</p><p><img src="/img/gpu/amd/format.png" srcset="/img/loading.gif" lazyload alt="PTE"></p><p>定义在：amdgpu-5.7.0-0\amd\amdgpu\amdgpu_vm.h</p><ul><li>M – Mtype</li><li>F – 进一步转换</li><li>L – 日志</li><li>P - PTE</li><li>SW – 软件</li><li>T – 平铺 (PRT)</li><li>W - 写入</li><li>R - 读取</li><li>X - 执行</li><li>Z - tmZ</li><li>C – 可缓存&#x2F;监听</li><li>S - 系统</li><li>V - 有效</li></ul><p>64 位 PTE 的格式为：</p><p>MTYPE 旨在控制基于描述符或指针的内存访问的 TC 缓存行为。此寄存器中指定的 Mtype 适用于没有关联描述符来指定 mtype 的内存访问。KMD 旨在根据寻址模式为非零 VMID 编程默认 mtype。对于 GPUVM32 和 64 寻址模式，KMD 应将默认 mtype 编程为 cached_NON_Coherent(NC)，对于 HSA32 和 64 寻址模式，默认 mtype 编程为 Cached Coherent(CC)。VMID 0 的 Mtype 编程为 Uncached。</p><p>以下是 GPU 上的 mType 值：</p><ul><li>0 - NC；缓存，非连贯</li><li>1 - WC；写入组合</li><li>2 - CC；缓存，连贯</li><li>3 - UC；未缓存的</li></ul><p><strong>V 位：</strong>V 位控制 PTE 是否为有效的 GPUVM 页面，如果将 V 位设置为 0，GPU MC 应该请求 ATC（IOMMU）进行进一步转换，因为它是主机页面而不是 GPU 页面，这用于实现共享虚拟内存。</p><p><strong>C 位：</strong>指示内存类型是监听还是非监听。在 Linux 驱动程序中，根据页面是否缓存来设置位。</p><p><strong>S 位：</strong>指示页面地址是否引用主机页面。在 Linux 驱动程序中，在为 GPU 访问分配主机页面时，始终在 PTE 中启用此位。</p><p>详细剖析见：</p><ul><li><a href="https://www.cnblogs.com/binlovetech/p/17571929.html">一步一图带你构建 Linux 页表体系 —— 详解虚拟内存如何与物理内存进行映射</a></li><li><a href="https://www.cnblogs.com/binlovetech/p/16914715.html">一步一图带你深入理解 Linux 物理内存管理</a></li></ul><p>PTE（Page Table Entry，页表项）和 PDE（Page Directory Entry，页目录项）是虚拟内存管理系统中用于内存地址转换的重要概念，尤其是在 x86 架构和类似的内存管理单元（MMU）中广泛使用。在现代操作系统中，虚拟内存通过分页机制实现，将虚拟地址空间映射到物理地址空间。这种映射通常分为多级，即通过多个层次的表逐步解析虚拟地址，最终找到对应的物理地址。</p><p>PTE:</p><ul><li><strong>页表项</strong>是虚拟内存系统中最低级别的映射条目，用于将虚拟页面映射到物理页面。</li><li><strong>结构</strong>：PTE 通常包含以下信息：<ul><li><strong>物理页框地址</strong>：指向物理内存中的一个页面的起始地址。</li><li><strong>状态标志</strong>：如有效位（valid bit）、可读&#x2F;可写标志（read&#x2F;write bit）、用户&#x2F;内核模式标志（user&#x2F;kernel mode bit）等。</li><li><strong>特权和缓存控制</strong>：可能包含一些关于该页面特权级别的标志和缓存控制位。</li></ul></li><li><strong>功能</strong>：当 CPU 需要访问某个虚拟地址时，PTE 会被查找到，以获取该地址对应的物理地址，从而进行实际的数据访问。</li></ul><p>PDE:</p><ul><li><strong>页目录项</strong>是在多级分页结构中用于指向下一级页表的条目，通常是第一级映射。</li><li><strong>结构</strong>：PDE 通常包含以下信息：<ul><li><strong>页表基地址</strong>：指向下一级页表的物理地址。</li><li><strong>状态标志</strong>：类似 PTE，也有一些控制和状态标志，如有效位、权限标志等。</li></ul></li><li><strong>功能</strong>：PDE 的作用是指向页表（即包含 PTE 的数据结构）。在多级分页机制中，CPU 会先查找 PDE 来确定具体使用哪个页表，然后再通过该页表中的 PTE 找到最终的物理地址。</li></ul><p>多级页表管理:</p><ul><li><strong>一级分页（单级页表）</strong>：整个虚拟地址空间通过一个单一的页表映射到物理地址。</li><li><strong>多级分页（例如两级或四级页表）</strong>：虚拟地址通过多个级别的表来逐步解析。最常见的是两级或四级页表结构。<ul><li><strong>二级页表</strong>：包含页目录（Page Directory）和页表（Page Table）。虚拟地址首先通过页目录项（PDE）找到页表，然后通过页表项（PTE）找到对应的物理页框。</li><li><strong>四级页表</strong>：进一步扩展，添加了页全局目录（Page Global Directory，PGD）和页上级目录（Page Upper Directory，PUD），用于处理更大的虚拟地址空间。</li></ul></li></ul>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-1ea41ce4" role="button" aria-expanded="false" aria-controls="collapse-1ea41ce4">
        <div class="fold-arrow">▶</div>BO（Buffer Object）
      </div>
      <div class="fold-collapse collapse" id="collapse-1ea41ce4">
        <div class="fold-content">
          <p>BO 是在图形驱动程序中用于管理内存缓冲区的抽象对象。在 AMD 的驱动程序中，BO 通常与图形资源（如纹理、 Frame Buffer 、顶点缓冲区等）相关联。这些缓冲区对象通过 TTM 或其他内存管理机制来管理和分配实际的内存资源。BO 具备以下特性：</p><ul><li>内存分配：通过 BO 接口，图形驱动程序可以为各种图形资源分配和管理内存。</li><li>引用计数：BO 通常带有引用计数机制，以确保在缓冲区不再需要时可以安全地释放内存。</li><li>内存映射：BO 可以被映射到用户空间，使得应用程序可以直接访问这些图形资源。</li></ul>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-c03e4a67" role="button" aria-expanded="false" aria-controls="collapse-c03e4a67">
        <div class="fold-arrow">▶</div>GART（Graphics Address Remapping Table）
      </div>
      <div class="fold-collapse collapse" id="collapse-c03e4a67">
        <div class="fold-content">
          <p>GART 是一个关键的内存管理机制，主要用于在系统内存（通常是主机的 RAM）和 GPU（图形处理单元）的地址空间之间进行地址映射和管理。</p><ol><li><strong>地址映射</strong>:<ul><li>GART 是一种内存管理单元（MMU），用于将系统内存中的物理地址映射到 GPU 虚拟地址空间（GPUVA）。这种映射允许 GPU 直接访问系统内存中的数据，而不必将所有数据都存储在有限的显存（VRAM）中。</li><li><strong>通过 GART，系统内存的一部分被虚拟化为 GPU 可以访问的地址范围，从而扩展了 GPU 的可用内存空间。</strong></li></ul></li><li><strong>页面调度与切换</strong>:<ul><li>GART 支持对大页面和小页面的管理，使得 GPU 能够灵活地访问系统内存中的不同大小的内存块。</li><li>当 GPU 需要访问不在显存中的数据时，GART 可以通过页表切换将这些数据从系统内存加载到 GPU 可访问的地址空间。</li></ul></li><li><strong>内存一致性与缓存</strong>:<ul><li>GART 负责确保 CPU 和 GPU 之间的数据一致性。它通过控制地址映射，确保当 CPU 修改了某些系统内存区域后，GPU 能够及时看到这些修改。</li><li>GART 还涉及到缓存控制，确保在不同情况下正确处理缓存一致性问题。</li></ul></li></ol><p>在 AMD GPU 架构中，GART 通常用于以下场景：</p><ul><li><strong>共享内存资源</strong>：当 GPU 需要频繁访问大量的系统内存数据时，使用 GART 允许这些数据直接映射到 GPU 的地址空间，而无需不断地在 VRAM 和系统内存之间移动数据。</li><li><strong>数据传输</strong>：在数据传输过程中，GART 可以有效地管理从系统内存到 GPU 地址空间的数据路径，提高数据传输效率。<br>用</li></ul><p>在实际的应用场景中，GART 被用于管理那些无法全部放入 VRAM 的数据，尤其是在需要处理大量数据或当 VRAM 资源受限的情况下。例如，在大型图形应用程序或游戏中，GART 允许 GPU 访问那些需要动态加载和处理的资源，如纹理、几何数据等。</p>
        </div>
      </div>
    </div>

<p>以下是具体细节的KMD代码实现分析：</p>
<h3 id="内存申请"><a href="#内存申请" class="headerlink" title="内存申请"></a>内存申请</h3>
    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-c0745a51" role="button" aria-expanded="false" aria-controls="collapse-c0745a51">
        <div class="fold-arrow">▶</div>kfd_ioctl_alloc_memory_of_gpu
      </div>
      <div class="fold-collapse collapse" id="collapse-c0745a51">
        <div class="fold-content">
          <p><img src="/img/gpu/amd/kfd_ioctl_alloc_memory_of_gpu.png" srcset="/img/loading.gif" lazyload alt="kfd_ioctl_alloc_memory_of_gpu"></p><p>用于在 GPU 虚拟内存（GPUVM）中分配内存。该函数处理内存的分配、初始化和管理，确保 GPU 和 CPU 之间的内存映射和访问符合预期。</p><p>参数解析</p><ul><li><strong><code>adev</code></strong>: 指向 <code>amdgpu_device</code> 结构体的指针，表示当前的 AMD GPU 设备。</li><li><strong><code>va</code></strong>: 虚拟地址，表示分配的内存在 GPU 虚拟地址空间中的位置。</li><li><strong><code>size</code></strong>: 要分配的内存的大小，以字节为单位。</li><li><strong><code>drm_priv</code></strong>: 表示与当前进程相关的 DRM 私有数据，通常是一个指向 <code>amdgpu_vm</code>（虚拟内存）结构的指针。</li><li><strong><code>mem</code></strong>: 指向指针的指针，函数返回时会指向一个已分配的 <code>kgd_mem</code> 结构体，表示分配的 GPU 内存。</li><li><strong><code>offset</code></strong>: 指向 64 位整数的指针，函数返回时会包含与分配的内存相关的偏移量（通常用于 mmap）。</li><li><strong><code>flags</code></strong>: 内存分配标志，指示如何分配内存（例如分配到 VRAM、GTT 等）。</li><li><strong><code>criu_resume</code></strong>: 布尔值，指示是否在 CRIU 恢复上下文中分配内存。</li></ul><p>主要执行流程</p><ol><li><strong>虚拟内存初始化</strong>:<ul><li>函数首先从 <code>drm_priv</code> 中提取出 <code>amdgpu_vm</code>（虚拟内存管理）结构。</li><li>根据 <code>flags</code> 确定分配内存的类型（VRAM、GTT、用户指针等），并设置相应的内存分配标志。</li></ul></li><li><strong>分配内存区域</strong>:<ul><li>如果标志表明内存应分配在 VRAM 中，函数会设置 <code>domain</code> 和 <code>alloc_domain</code> 为 VRAM，并根据标志确定其他分配选项，如 CPU 访问要求等。</li><li>如果标志指示内存应分配在 GTT（显卡地址转换表）中，函数会相应设置 <code>domain</code> 和 <code>alloc_domain</code> 为 GTT。</li><li>函数还会处理其他特殊情况，如用户指针（<code>USERPTR</code>）或 <code>DOORBELL</code> 内存。</li></ul></li><li><strong>分配 <code>kgd_mem</code> 结构</strong>:<ul><li>函数为 <code>kgd_mem</code> 结构分配内存，并初始化它的一些基本字段，如分配标志和同步对象。</li></ul></li><li><strong>内存预留与分配</strong>:<ul><li>函数会调用 <code>amdgpu_amdkfd_reserve_mem_limit</code> 预留内存限制，以确保足够的内存可供分配。</li><li>使用 <code>amdgpu_gem_object_create</code> 创建实际的缓冲区对象（<code>BO</code>），这代表了分配的 GPU 内存。</li></ul></li><li><strong>内存映射与管理</strong>:<ul><li>如果是用户指针内存（<code>USERPTR</code>），函数会初始化用户页表。</li><li>如果是 <code>DOORBELL</code> 或 <code>MMIO_REMAP</code> 内存，函数会将 BO 固定在 GTT 中。</li><li>最后，函数会将偏移量返回给调用者，以便于后续的内存映射。</li></ul></li><li><strong>错误处理与回滚</strong>:<ul><li>函数包含多个错误处理路径。如果在内存分配或初始化过程中遇到问题，它会清理已分配的资源，并返回相应的错误代码。</li></ul></li></ol><p>关键概念</p><ul><li><strong>BO (Buffer Object)</strong>: 在图形驱动程序中用于表示 GPU 上的内存缓冲区。</li><li><strong>GTT (Graphics Translation Table)</strong>: 用于管理系统内存与 GPU 显存之间的映射。</li><li><strong>VRAM</strong>: 显存，GPU 上的高速内存，用于存储需要快速访问的数据，如纹理、 Frame Buffer 等。</li><li><strong>User Pointer (USERPTR)</strong>: 允许用户空间的指针直接映射到 GPU 的地址空间，通常用于高效的数据共享。</li></ul><p>该函数的作用</p><p>这个函数的作用是确保在适当的内存域（VRAM、GTT 等）中分配 GPU 内存，并处理复杂的内存映射需求，同时提供足够的灵活性以应对不同的内存分配场景（如用户指针、DOORBELL 等）。它是 AMD GPU 驱动程序中的一个重要部分，确保了 GPU 内存的高效管理和使用。</p>
        </div>
      </div>
    </div>

<h3 id="内存映射"><a href="#内存映射" class="headerlink" title="内存映射"></a>内存映射</h3>
    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-b897114f" role="button" aria-expanded="false" aria-controls="collapse-b897114f">
        <div class="fold-arrow">▶</div>kfd_ioctl_map_memory_to_gpu
      </div>
      <div class="fold-collapse collapse" id="collapse-b897114f">
        <div class="fold-content">
          <p><img src="/img/gpu/amd/kfd_ioctl_map_memory_to_gpu.png" srcset="/img/loading.gif" lazyload alt="kfd_ioctl_map_memory_to_gpu"></p>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-7757a5f2" role="button" aria-expanded="false" aria-controls="collapse-7757a5f2">
        <div class="fold-arrow">▶</div>PDE Update
      </div>
      <div class="fold-collapse collapse" id="collapse-7757a5f2">
        <div class="fold-content">
          <p><img src="/img/gpu/amd/pde.png" srcset="/img/loading.gif" lazyload alt="pde"></p><p><img src="/img/gpu/amd/amdgpu_vm_update_pdes.png" srcset="/img/loading.gif" lazyload alt="amdgpu_vm_update_pdes"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><code class="hljs c">amdgpu_vm_pde_update --&gt; vm-&gt;update_funcs-&gt;update --&gt; amdgpu_vm_sdma_update --&gt; amdgpu_vm_sdma_set_ptes / amdgpu_vm_sdma_copy_ptes<br><br><span class="hljs-comment">// amdgpu_vm_pt_clear --&gt; vm-&gt;update_funcs-&gt;update --&gt; amdgpu_vm_sdma_update</span><br><span class="hljs-comment">// amdgpu_vm_pte_update_flags --&gt; vm-&gt;update_funcs-&gt;update --&gt; amdgpu_vm_sdma_update</span><br><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">amdgpu_vm_update_funcs</span> <span class="hljs-title">amdgpu_vm_sdma_funcs</span> =</span> &#123;<br>    .map_table = amdgpu_vm_sdma_map_table,<br>    .prepare = amdgpu_vm_sdma_prepare,<br>    .update = amdgpu_vm_sdma_update,<br>    .commit = amdgpu_vm_sdma_commit<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * amdgpu_vm_sdma_set_ptes - helper to call the right asic function</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @p: see amdgpu_vm_update_params definition</span><br><span class="hljs-comment"> * @bo: PD/PT to update</span><br><span class="hljs-comment"> * @pe: byte offset of the PDE/PTE, relative to start of PDB/PTB</span><br><span class="hljs-comment"> * @addr: dst addr to write into pe</span><br><span class="hljs-comment"> * @count: number of page entries to update</span><br><span class="hljs-comment"> * @incr: increase next addr by incr bytes</span><br><span class="hljs-comment"> * @flags: hw access flags</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Traces the parameters and calls the right asic functions</span><br><span class="hljs-comment"> * to setup the page table using the DMA.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">amdgpu_vm_sdma_set_ptes</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_vm_update_params *p,</span><br><span class="hljs-params">                                    <span class="hljs-keyword">struct</span> amdgpu_bo *bo, <span class="hljs-type">uint64_t</span> pe,</span><br><span class="hljs-params">                                    <span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">unsigned</span> count,</span><br><span class="hljs-params">                                    <span class="hljs-type">uint32_t</span> incr, <span class="hljs-type">uint64_t</span> flags)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">amdgpu_ib</span> *<span class="hljs-title">ib</span> =</span> p-&gt;job-&gt;ibs;<br><br>    pe += amdgpu_gmc_sign_extend(amdgpu_bo_gpu_offset_no_check(bo));<br>    trace_amdgpu_vm_set_ptes(pe, addr, count, incr, flags, p-&gt;immediate);<br>    <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">3</span>) &#123;<br>        amdgpu_vm_write_pte(p-&gt;adev, ib, pe, addr | flags,<br>                    count, incr);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        amdgpu_vm_set_pte_pde(p-&gt;adev, ib, pe, addr,<br>                    count, incr, flags);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * amdgpu_vm_sdma_copy_ptes - copy the PTEs from mapping</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @p: see amdgpu_vm_update_params definition</span><br><span class="hljs-comment"> * @bo: PD/PT to update</span><br><span class="hljs-comment"> * @pe: addr of the page entry</span><br><span class="hljs-comment"> * @count: number of page entries to copy</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Traces the parameters and calls the DMA function to copy the PTEs.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">amdgpu_vm_sdma_copy_ptes</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_vm_update_params *p,</span><br><span class="hljs-params">                                    <span class="hljs-keyword">struct</span> amdgpu_bo *bo, <span class="hljs-type">uint64_t</span> pe,</span><br><span class="hljs-params">                                    <span class="hljs-type">unsigned</span> count)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">amdgpu_ib</span> *<span class="hljs-title">ib</span> =</span> p-&gt;job-&gt;ibs;<br>    <span class="hljs-type">uint64_t</span> src = ib-&gt;gpu_addr;<br><br>    src += p-&gt;num_dw_left * <span class="hljs-number">4</span>;<br><br>    pe += amdgpu_gmc_sign_extend(amdgpu_bo_gpu_offset_no_check(bo));<br>    trace_amdgpu_vm_copy_ptes(pe, src, count, p-&gt;immediate);<br><br>    amdgpu_vm_copy_pte(p-&gt;adev, ib, pe, src, count);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> amdgpu_vm_copy_pte(adev, ib, pe, src, count) ((adev)-&gt;vm_manager.vm_pte_funcs-&gt;copy_pte((ib), (pe), (src), (count)))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> amdgpu_vm_write_pte(adev, ib, pe, value, count, incr) ((adev)-&gt;vm_manager.vm_pte_funcs-&gt;write_pte((ib), (pe), (value), (count), (incr)))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> amdgpu_vm_set_pte_pde(adev, ib, pe, addr, count, incr, flags) ((adev)-&gt;vm_manager.vm_pte_funcs-&gt;set_pte_pde((ib), (pe), (addr), (count), (incr), (flags)))</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">amdgpu_vm_pte_funcs</span> <span class="hljs-title">sdma_v4_0_vm_pte_funcs</span> =</span> &#123;<br>    .copy_pte_num_dw = <span class="hljs-number">7</span>,<br>    .copy_pte = sdma_v4_0_vm_copy_pte,<br><br>    .write_pte = sdma_v4_0_vm_write_pte,<br>    .set_pte_pde = sdma_v4_0_vm_set_pte_pde,<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * sdma_v4_0_vm_copy_pte - update PTEs by copying them from the GART</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @ib: indirect buffer to fill with commands</span><br><span class="hljs-comment"> * @pe: addr of the page entry</span><br><span class="hljs-comment"> * @src: src addr to copy from</span><br><span class="hljs-comment"> * @count: number of page entries to update</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Update PTEs by copying them from the GART using sDMA (VEGA10).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">sdma_v4_0_vm_copy_pte</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_ib *ib,</span><br><span class="hljs-params">                                    <span class="hljs-type">uint64_t</span> pe, <span class="hljs-type">uint64_t</span> src,</span><br><span class="hljs-params">                                    <span class="hljs-type">unsigned</span> count)</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> bytes = count * <span class="hljs-number">8</span>;<br><br>    ib-&gt;ptr[ib-&gt;length_dw++] = SDMA_PKT_HEADER_OP(SDMA_OP_COPY) |<br>        SDMA_PKT_HEADER_SUB_OP(SDMA_SUBOP_COPY_LINEAR);<br>    ib-&gt;ptr[ib-&gt;length_dw++] = bytes - <span class="hljs-number">1</span>;<br>    ib-&gt;ptr[ib-&gt;length_dw++] = <span class="hljs-number">0</span>; <span class="hljs-comment">/* src/dst endian swap */</span><br>    ib-&gt;ptr[ib-&gt;length_dw++] = lower_32_bits(src);<br>    ib-&gt;ptr[ib-&gt;length_dw++] = upper_32_bits(src);<br>    ib-&gt;ptr[ib-&gt;length_dw++] = lower_32_bits(pe);<br>    ib-&gt;ptr[ib-&gt;length_dw++] = upper_32_bits(pe);<br><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * sdma_v4_0_vm_write_pte - update PTEs by writing them manually</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @ib: indirect buffer to fill with commands</span><br><span class="hljs-comment"> * @pe: addr of the page entry</span><br><span class="hljs-comment"> * @value: dst addr to write into pe</span><br><span class="hljs-comment"> * @count: number of page entries to update</span><br><span class="hljs-comment"> * @incr: increase next addr by incr bytes</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Update PTEs by writing them manually using sDMA (VEGA10).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">sdma_v4_0_vm_write_pte</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_ib *ib, <span class="hljs-type">uint64_t</span> pe,</span><br><span class="hljs-params">                                    <span class="hljs-type">uint64_t</span> value, <span class="hljs-type">unsigned</span> count,</span><br><span class="hljs-params">                                    <span class="hljs-type">uint32_t</span> incr)</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> ndw = count * <span class="hljs-number">2</span>;<br><br>    ib-&gt;ptr[ib-&gt;length_dw++] = SDMA_PKT_HEADER_OP(SDMA_OP_WRITE) |<br>        SDMA_PKT_HEADER_SUB_OP(SDMA_SUBOP_WRITE_LINEAR);<br>    ib-&gt;ptr[ib-&gt;length_dw++] = lower_32_bits(pe);<br>    ib-&gt;ptr[ib-&gt;length_dw++] = upper_32_bits(pe);<br>    ib-&gt;ptr[ib-&gt;length_dw++] = ndw - <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span> (; ndw &gt; <span class="hljs-number">0</span>; ndw -= <span class="hljs-number">2</span>) &#123;<br>        ib-&gt;ptr[ib-&gt;length_dw++] = lower_32_bits(value);<br>        ib-&gt;ptr[ib-&gt;length_dw++] = upper_32_bits(value);<br>        value += incr;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * sdma_v4_0_vm_set_pte_pde - update the page tables using sDMA</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @ib: indirect buffer to fill with commands</span><br><span class="hljs-comment"> * @pe: addr of the page entry</span><br><span class="hljs-comment"> * @addr: dst addr to write into pe</span><br><span class="hljs-comment"> * @count: number of page entries to update</span><br><span class="hljs-comment"> * @incr: increase next addr by incr bytes</span><br><span class="hljs-comment"> * @flags: access flags</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Update the page tables using sDMA (VEGA10).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">sdma_v4_0_vm_set_pte_pde</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_ib *ib,</span><br><span class="hljs-params">                    <span class="hljs-type">uint64_t</span> pe,</span><br><span class="hljs-params">                    <span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">unsigned</span> count,</span><br><span class="hljs-params">                    <span class="hljs-type">uint32_t</span> incr, <span class="hljs-type">uint64_t</span> flags)</span><br>&#123;<br>    <span class="hljs-comment">/* for physically contiguous pages (vram) */</span><br>    ib-&gt;ptr[ib-&gt;length_dw++] = SDMA_PKT_HEADER_OP(SDMA_OP_PTEPDE);<br>    ib-&gt;ptr[ib-&gt;length_dw++] = lower_32_bits(pe); <span class="hljs-comment">/* dst addr */</span><br>    ib-&gt;ptr[ib-&gt;length_dw++] = upper_32_bits(pe);<br>    ib-&gt;ptr[ib-&gt;length_dw++] = lower_32_bits(flags); <span class="hljs-comment">/* mask */</span><br>    ib-&gt;ptr[ib-&gt;length_dw++] = upper_32_bits(flags);<br>    ib-&gt;ptr[ib-&gt;length_dw++] = lower_32_bits(addr); <span class="hljs-comment">/* value */</span><br>    ib-&gt;ptr[ib-&gt;length_dw++] = upper_32_bits(addr);<br>    ib-&gt;ptr[ib-&gt;length_dw++] = incr; <span class="hljs-comment">/* increment size */</span><br>    ib-&gt;ptr[ib-&gt;length_dw++] = <span class="hljs-number">0</span>;<br>    ib-&gt;ptr[ib-&gt;length_dw++] = count - <span class="hljs-number">1</span>; <span class="hljs-comment">/* number of entries */</span><br>&#125;<br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-32ef457a" role="button" aria-expanded="false" aria-controls="collapse-32ef457a">
        <div class="fold-arrow">▶</div>TLB Flush
      </div>
      <div class="fold-collapse collapse" id="collapse-32ef457a">
        <div class="fold-content">
          <blockquote><p>当缓存中未写入的数据量达到一定水平时，控制器会定期将缓存数据写入驱动器。此写入过程称为“刷新”。<br>控制器使用两种算法来刷新缓存：基于需求和基于年龄。控制器使用基于需求的算法，直到缓存数据量低于缓存刷新阈值。默认情况下，当 80% 的缓存正在使用时，刷新开始。<br>在系统管理器中，您可以设置“启动需求缓存刷新”阈值，以最好地支持环境中使用的 I&#x2F;O 类型。在主要进行写入操作的环境中，您应该将“启动需求缓存刷新”百分比设置为较高，以增加任何新的写入请求都可以由缓存处理而无需转到磁盘的可能性。高百分比设置会限制缓存刷新的次数，以便更多数据保留在缓存中，从而增加更多缓存命中的机会。<br>在 I&#x2F;O 不稳定（数据突发）的环境中，您可以使用较低的缓存刷新，以便系统在数据突发之间频繁刷新缓存。在处理各种负载的多样化 I&#x2F;O 环境中，或者当负载类型未知时，将阈值设置为 50% 是一个不错的中间值。请注意，如果选择的启动百分比低于 80%，则可能会看到性能下降，因为主机读取所需的数据可能不可用。选择较低的百分比还会增加维持缓存级别所需的磁盘写入次数，从而增加系统开销。<br>基于年龄的算法指定写入数据在有资格刷新到磁盘之前可以保留在缓存中的时间段。控制器使用基于年龄的算法，直到达到缓存刷新阈值。默认值为 10 秒，但此时间段仅在非活动期间计算。您无法在系统管理器中修改刷新时间；相反，您必须使用命令行界面 (CLI) 中的“设置存储阵列”命令。</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">gfx_v9_0_kiq_invalidate_tlbs</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_ring *kiq_ring,</span><br><span class="hljs-params">    <span class="hljs-type">uint16_t</span> pasid, <span class="hljs-type">uint32_t</span> flush_type,</span><br><span class="hljs-params">    <span class="hljs-type">bool</span> all_hub)</span><br>&#123;<br>    amdgpu_ring_write(kiq_ring, PACKET3(PACKET3_INVALIDATE_TLBS, <span class="hljs-number">0</span>));<br>    amdgpu_ring_write(kiq_ring,<br>        PACKET3_INVALIDATE_TLBS_DST_SEL(<span class="hljs-number">1</span>) |<br>        PACKET3_INVALIDATE_TLBS_ALL_HUB(all_hub) |<br>        PACKET3_INVALIDATE_TLBS_PASID(pasid) |<br>        PACKET3_INVALIDATE_TLBS_FLUSH_TYPE(flush_type));<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/gpu/amd/amdgpu_amdkfd_flush_gpu_tlb_pasid.png" srcset="/img/loading.gif" lazyload alt="amdgpu_amdkfd_flush_gpu_tlb_pasid"></p><p>amdgpu_amdkfd_flush_gpu_tlb_pasid –&gt; amdgpu_gmc_flush_gpu_tlb_pasid –&gt; gmc_v9_0_flush_gpu_tlb_pasid –&gt; gfx_v9_0_kiq_invalidate_tlbs</p><p>其中，kfd_ioctl_unmap_memory_from_gpu &#x2F; svm_range_unmap_from_gpus  采用 TLB_FLUSH_HEAVYWEIGHT 策略</p><p>第二路径：<br>gmc_v9_0_flush_gpu_tlb_pasid –&gt; gfx_v9_0_kiq_invalidate_tlbs</p><p>gmc_v9_0_flush_gpu_tlb_pasid –&gt; gmc_v9_0_flush_gpu_tlb（无pasid flush）</p><p>gmc_v9_0_hw_init –&gt; gmc_v9_0_flush_gpu_tlb</p><p><strong>amdgpu_gmc_flush_gpu_tlb</strong> –&gt; gmc_v9_0_flush_gpu_tlb</p><p><img src="/img/gpu/amd/amdgpu_gmc_flush_gpu_tlb.png" srcset="/img/loading.gif" lazyload alt="amdgpu_gmc_flush_gpu_tlb"></p>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-9a1c5b83" role="button" aria-expanded="false" aria-controls="collapse-9a1c5b83">
        <div class="fold-arrow">▶</div>KMD Intialization
      </div>
      <div class="fold-collapse collapse" id="collapse-9a1c5b83">
        <div class="fold-content">
          <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> amdgpu_tmz = <span class="hljs-number">-1</span>; <span class="hljs-comment">/* auto */</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * DOC: tmz (int)</span><br><span class="hljs-comment"> * Trusted Memory Zone (TMZ) is a method to protect data being written</span><br><span class="hljs-comment"> * to or read from memory.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The default value: 0 (off).  <span class="hljs-doctag">TODO:</span> change to auto till it is completed.</span><br><span class="hljs-comment"> */</span><br>MODULE_PARM_DESC(tmz, <span class="hljs-string">&quot;Enable TMZ feature (-1 = auto (default), 0 = off, 1 = on)&quot;</span>);<br>module_param_named(tmz, amdgpu_tmz, <span class="hljs-type">int</span>, <span class="hljs-number">0444</span>);<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * amdgpu_gmc_tmz_set -- check and set if a device supports TMZ</span><br><span class="hljs-comment"> * @adev: amdgpu_device pointer</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Check and set if an the device @adev supports Trusted Memory</span><br><span class="hljs-comment"> * Zones (TMZ).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">amdgpu_gmc_tmz_set</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_device *adev)</span><br>&#123;<br>    <span class="hljs-keyword">switch</span> (adev-&gt;asic_type) &#123;<br>    <span class="hljs-keyword">default</span>:<br>        adev-&gt;gmc.tmz_enabled = <span class="hljs-literal">false</span>;<br>        dev_info(adev-&gt;dev, <span class="hljs-string">&quot;Trusted Memory Zone (TMZ) feature not supported\n&quot;</span>);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-d02d7b34" role="button" aria-expanded="false" aria-controls="collapse-d02d7b34">
        <div class="fold-arrow">▶</div>Indirect Frame Buffer
      </div>
      <div class="fold-collapse collapse" id="collapse-d02d7b34">
        <div class="fold-content">
          <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * amdgpu_ib_schedule - schedule an IB (Indirect Buffer) on the ring</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @ring: ring index the IB is associated with</span><br><span class="hljs-comment"> * @num_ibs: number of IBs to schedule</span><br><span class="hljs-comment"> * @ibs: IB objects to schedule</span><br><span class="hljs-comment"> * @job: job to schedule</span><br><span class="hljs-comment"> * @f: fence created during this submission</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Schedule an IB on the associated ring (all asics).</span><br><span class="hljs-comment"> * Returns 0 on success, error on failure.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * On SI, there are two parallel engines fed from the primary ring,</span><br><span class="hljs-comment"> * the CE (Constant Engine) and the DE (Drawing Engine).  Since</span><br><span class="hljs-comment"> * resource descriptors have moved to memory, the CE allows you to</span><br><span class="hljs-comment"> * prime the caches while the DE is updating register state so that</span><br><span class="hljs-comment"> * the resource descriptors will be already in cache when the draw is</span><br><span class="hljs-comment"> * processed.  To accomplish this, the userspace driver submits two</span><br><span class="hljs-comment"> * IBs, one for the CE and one for the DE.  If there is a CE IB (called</span><br><span class="hljs-comment"> * a CONST_IB), it will be put on the ring prior to the DE IB.  Prior</span><br><span class="hljs-comment"> * to SI there was just a DE IB.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">amdgpu_ib_schedule</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_ring *ring, <span class="hljs-type">unsigned</span> num_ibs,</span><br><span class="hljs-params">                        <span class="hljs-keyword">struct</span> amdgpu_ib *ibs, <span class="hljs-keyword">struct</span> amdgpu_job *job,</span><br><span class="hljs-params">                        <span class="hljs-keyword">struct</span> dma_fence **f)</span><br>&#123;<br>    <span class="hljs-comment">/* Setup initial TMZiness and send it off.</span><br><span class="hljs-comment">    */</span><br>    secure = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (job &amp;&amp; ring-&gt;funcs-&gt;emit_frame_cntl) &#123;<br>        secure = ib-&gt;flags &amp; AMDGPU_IB_FLAGS_SECURE;<br>        amdgpu_ring_emit_frame_cntl(ring, <span class="hljs-literal">true</span>, secure);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> amdgpu_ring_emit_frame_cntl(r, b, s) (r)-&gt;funcs-&gt;emit_frame_cntl((r), (b), (s))</span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET3_FRAME_CONTROL   0x90</span><br><span class="hljs-meta">#           <span class="hljs-keyword">define</span> FRAME_TM     (1 &lt;&lt; 0)</span><br><span class="hljs-meta">#           <span class="hljs-keyword">define</span> FRAME_CMD(x) ((x) &lt;&lt; 28)</span><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * x=0: tmz_begin</span><br><span class="hljs-comment">             * x=1: tmz_end</span><br><span class="hljs-comment">             */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">gfx_v9_0_ring_emit_frame_cntl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_ring *ring, <span class="hljs-type">bool</span> start,</span><br><span class="hljs-params">                                            <span class="hljs-type">bool</span> secure)</span><br>&#123;<br>    <span class="hljs-type">uint32_t</span> v = secure ? FRAME_TMZ : <span class="hljs-number">0</span>;<br><br>    amdgpu_ring_write(ring, PACKET3(PACKET3_FRAME_CONTROL, <span class="hljs-number">0</span>));<br>    amdgpu_ring_write(ring, v | FRAME_CMD(start ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-432e828f" role="button" aria-expanded="false" aria-controls="collapse-432e828f">
        <div class="fold-arrow">▶</div>TTM Buffer copy
      </div>
      <div class="fold-collapse collapse" id="collapse-432e828f">
        <div class="fold-content">
          <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * amdgpu_ttm_copy_mem_to_mem - Helper function for copy</span><br><span class="hljs-comment"> * @adev: amdgpu device</span><br><span class="hljs-comment"> * @src: buffer/address where to read from</span><br><span class="hljs-comment"> * @dst: buffer/address where to write to</span><br><span class="hljs-comment"> * @size: number of bytes to copy</span><br><span class="hljs-comment"> * @tmz: if a secure copy should be used</span><br><span class="hljs-comment"> * @resv: resv object to sync to</span><br><span class="hljs-comment"> * @f: Returns the last fence if multiple jobs are submitted.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The function copies @size bytes from &#123;src-&gt;mem + src-&gt;offset&#125; to</span><br><span class="hljs-comment"> * &#123;dst-&gt;mem + dst-&gt;offset&#125;. src-&gt;bo and dst-&gt;bo could be same BO for a</span><br><span class="hljs-comment"> * move and different for a BO to BO copy.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">amdgpu_ttm_copy_mem_to_mem</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_device *adev,</span><br><span class="hljs-params">                                <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> amdgpu_copy_mem *src,</span><br><span class="hljs-params">                                <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> amdgpu_copy_mem *dst,</span><br><span class="hljs-params">                                <span class="hljs-type">uint64_t</span> size, <span class="hljs-type">bool</span> tmz,</span><br><span class="hljs-params">                                <span class="hljs-keyword">struct</span> dma_resv *resv,</span><br><span class="hljs-params">                                <span class="hljs-keyword">struct</span> dma_fence **f)</span><br><br>--&gt; <span class="hljs-title function_">amdgpu_copy_buffer</span><span class="hljs-params">()</span> --&gt; <span class="hljs-title function_">amdgpu_emit_copy_buffer</span><span class="hljs-params">()</span> --&gt; <span class="hljs-title function_">sdma_v4_0_emit_copy_buffer</span><span class="hljs-params">()</span><br></code></pre></td></tr></table></figure><p><img src="/img/gpu/amd/amdgpu_ttm_copy_mem_to_mem.png" srcset="/img/loading.gif" lazyload alt="amdgpu_ttm_copy_mem_to_mem"></p>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-b83a4609" role="button" aria-expanded="false" aria-controls="collapse-b83a4609">
        <div class="fold-arrow">▶</div>SDMA Copy Buffer
      </div>
      <div class="fold-collapse collapse" id="collapse-b83a4609">
        <div class="fold-content">
          <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*define for tmz field*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SDMA_PKT_COPY_LINEAR_HEADER_tmz_offset 0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SDMA_PKT_COPY_LINEAR_HEADER_tmz_mask   0x00000001</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SDMA_PKT_COPY_LINEAR_HEADER_tmz_shift  18</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SDMA_PKT_COPY_LINEAR_HEADER_TMZ(x) (((x) &amp; SDMA_PKT_COPY_LINEAR_HEADER_tmz_mask) &lt;&lt; SDMA_PKT_COPY_LINEAR_HEADER_tmz_shift)</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">amdgpu_copy_buffer</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_ring *ring, <span class="hljs-type">uint64_t</span> src_offset,</span><br><span class="hljs-params">                        <span class="hljs-type">uint64_t</span> dst_offset, <span class="hljs-type">uint32_t</span> byte_count,</span><br><span class="hljs-params">                        <span class="hljs-keyword">struct</span> dma_resv *resv,</span><br><span class="hljs-params">                        <span class="hljs-keyword">struct</span> dma_fence **fence, <span class="hljs-type">bool</span> direct_submit,</span><br><span class="hljs-params">                        <span class="hljs-type">bool</span> vm_needs_flush, <span class="hljs-type">bool</span> tmz)</span><br><br>--&gt; <span class="hljs-title function_">amdgpu_emit_copy_buffer</span><span class="hljs-params">(adev, &amp;job-&gt;ibs[<span class="hljs-number">0</span>], src_offset,</span><br><span class="hljs-params">                                dst_offset, cur_size_in_bytes, tmz)</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> amdgpu_emit_copy_buffer(adev, ib, s, d, b, t) (adev)-&gt;mman.buffer_funcs-&gt;emit_copy_buffer((ib),  (s), (d), (b), (t))</span><br><br><span class="hljs-type">void</span> (*emit_copy_buffer)(<span class="hljs-keyword">struct</span> amdgpu_ib *ib,<br>                        <span class="hljs-comment">/* src addr in bytes */</span><br>                        <span class="hljs-type">uint64_t</span> src_offset,<br>                        <span class="hljs-comment">/* dst addr in bytes */</span><br>                        <span class="hljs-type">uint64_t</span> dst_offset,<br>                        <span class="hljs-comment">/* number of byte to transfer */</span><br>                        <span class="hljs-type">uint32_t</span> byte_count,<br>                        <span class="hljs-type">bool</span> tmz);<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * sdma_v4_0_emit_copy_buffer - copy buffer using the sDMA engine</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @ib: indirect buffer to copy to</span><br><span class="hljs-comment"> * @src_offset: src GPU address</span><br><span class="hljs-comment"> * @dst_offset: dst GPU address</span><br><span class="hljs-comment"> * @byte_count: number of bytes to xfer</span><br><span class="hljs-comment"> * @tmz: if a secure copy should be used</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Copy GPU buffers using the DMA engine (VEGA10/12).</span><br><span class="hljs-comment"> * Used by the amdgpu ttm implementation to move pages if</span><br><span class="hljs-comment"> * registered as the asic copy callback.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">sdma_v4_0_emit_copy_buffer</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_ib *ib,</span><br><span class="hljs-params">                                        <span class="hljs-type">uint64_t</span> src_offset,</span><br><span class="hljs-params">                                        <span class="hljs-type">uint64_t</span> dst_offset,</span><br><span class="hljs-params">                                        <span class="hljs-type">uint32_t</span> byte_count,</span><br><span class="hljs-params">                                        <span class="hljs-type">bool</span> tmz)</span><br>&#123;<br>    ib-&gt;ptr[ib-&gt;length_dw++] = SDMA_PKT_HEADER_OP(SDMA_OP_COPY) |<br>        SDMA_PKT_HEADER_SUB_OP(SDMA_SUBOP_COPY_LINEAR) |<br>        SDMA_PKT_COPY_LINEAR_HEADER_TMZ(tmz ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>);<br>    ib-&gt;ptr[ib-&gt;length_dw++] = byte_count - <span class="hljs-number">1</span>;<br>    ib-&gt;ptr[ib-&gt;length_dw++] = <span class="hljs-number">0</span>; <span class="hljs-comment">/* src/dst endian swap */</span><br>    ib-&gt;ptr[ib-&gt;length_dw++] = lower_32_bits(src_offset);<br>    ib-&gt;ptr[ib-&gt;length_dw++] = upper_32_bits(src_offset);<br>    ib-&gt;ptr[ib-&gt;length_dw++] = lower_32_bits(dst_offset);<br>    ib-&gt;ptr[ib-&gt;length_dw++] = upper_32_bits(dst_offset);<br>&#125;<br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-33e598f1" role="button" aria-expanded="false" aria-controls="collapse-33e598f1">
        <div class="fold-arrow">▶</div>TTM GART Bind
      </div>
      <div class="fold-collapse collapse" id="collapse-33e598f1">
        <div class="fold-content">
          <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">amdgpu_ttm_gart_bind</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_device *adev,</span><br><span class="hljs-params">     <span class="hljs-keyword">struct</span> ttm_buffer_object *tbo,</span><br><span class="hljs-params">     <span class="hljs-type">uint64_t</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (amdgpu_bo_encrypted(abo))<br>        flags |= AMDGPU_PTE_TMZ;<br>&#125;<br><br>--&gt; amdgpu_gart_bind(adev, gtt-&gt;offset, page_idx, gtt-&gt;ttm.dma_address, flags);<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * amdgpu_gart_bind - bind pages into the gart page table</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @adev: amdgpu_device pointer</span><br><span class="hljs-comment"> * @offset: offset into the GPU&#x27;s gart aperture</span><br><span class="hljs-comment"> * @pages: number of pages to bind</span><br><span class="hljs-comment"> * @dma_addr: DMA addresses of pages</span><br><span class="hljs-comment"> * @flags: page table entry flags</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Binds the requested pages to the gart page table</span><br><span class="hljs-comment"> * (all asics).</span><br><span class="hljs-comment"> * Returns 0 for success, -EINVAL for failure.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">amdgpu_gart_bind</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_device *adev, <span class="hljs-type">uint64_t</span> offset,</span><br><span class="hljs-params">                    <span class="hljs-type">int</span> pages, <span class="hljs-type">dma_addr_t</span> *dma_addr,</span><br><span class="hljs-params">                    <span class="hljs-type">uint64_t</span> flags)</span><br><br>--&gt; <span class="hljs-title function_">amdgpu_gart_map</span><span class="hljs-params">(adev, offset, pages, dma_addr, flags, adev-&gt;gart.ptr)</span>; --&gt; amdgpu_gmc_set_pte_pde(adev, dst, t, page_base, flags);<br></code></pre></td></tr></table></figure><p><img src="/img/gpu/amd/amdgpu_gart_map.png" srcset="/img/loading.gif" lazyload alt="amdgpu_gart_map"></p>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-12442369" role="button" aria-expanded="false" aria-controls="collapse-12442369">
        <div class="fold-arrow">▶</div>TTM Map Buffer to GART
      </div>
      <div class="fold-collapse collapse" id="collapse-12442369">
        <div class="fold-content">
          <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * amdgpu_ttm_map_buffer - Map memory into the GART windows</span><br><span class="hljs-comment"> * @bo: buffer object to map</span><br><span class="hljs-comment"> * @mem: memory object to map</span><br><span class="hljs-comment"> * @mm_cur: range to map</span><br><span class="hljs-comment"> * @window: which GART window to use</span><br><span class="hljs-comment"> * @ring: DMA ring to use for the copy</span><br><span class="hljs-comment"> * @tmz: if we should setup a TMZ enabled mapping</span><br><span class="hljs-comment"> * @size: in number of bytes to map, out number of bytes mapped</span><br><span class="hljs-comment"> * @addr: resulting address inside the MC address space</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Setup one of the GART windows to access a specific piece of memory or return</span><br><span class="hljs-comment"> * the physical address for local memory.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">amdgpu_ttm_map_buffer</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ttm_buffer_object *bo,</span><br><span class="hljs-params">                                    <span class="hljs-keyword">struct</span> ttm_resource *mem,</span><br><span class="hljs-params">                                    <span class="hljs-keyword">struct</span> amdgpu_res_cursor *mm_cur,</span><br><span class="hljs-params">                                    <span class="hljs-type">unsigned</span> window, <span class="hljs-keyword">struct</span> amdgpu_ring *ring,</span><br><span class="hljs-params">                                    <span class="hljs-type">bool</span> tmz, <span class="hljs-type">uint64_t</span> *size, <span class="hljs-type">uint64_t</span> *addr)</span><br><br>--&gt; <span class="hljs-title function_">amdgpu_gart_map</span><span class="hljs-params">(adev, <span class="hljs-number">0</span>, num_pages, dma_addr, flags, cpu_addr)</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * amdgpu_gart_map - map dma_addresses into GART entries</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @adev: amdgpu_device pointer</span><br><span class="hljs-comment"> * @offset: offset into the GPU&#x27;s gart aperture</span><br><span class="hljs-comment"> * @pages: number of pages to bind</span><br><span class="hljs-comment"> * @dma_addr: DMA addresses of pages</span><br><span class="hljs-comment"> * @flags: page table entry flags</span><br><span class="hljs-comment"> * @dst: CPU address of the gart table</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Map the dma_addresses into GART entries (all asics).</span><br><span class="hljs-comment"> * Returns 0 for success, -EINVAL for failure.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">amdgpu_gart_map</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_device *adev, <span class="hljs-type">uint64_t</span> offset,</span><br><span class="hljs-params">                    <span class="hljs-type">int</span> pages, <span class="hljs-type">dma_addr_t</span> *dma_addr, <span class="hljs-type">uint64_t</span> flags,</span><br><span class="hljs-params">                    <span class="hljs-type">void</span> *dst)</span><br><br>--&gt; <span class="hljs-title function_">amdgpu_gmc_set_pte_pde</span><span class="hljs-params">(adev, dst, t, page_base, flags)</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * amdgpu_gmc_set_pte_pde - update the page tables using CPU</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @adev: amdgpu_device pointer</span><br><span class="hljs-comment"> * @cpu_pt_addr: cpu address of the page table</span><br><span class="hljs-comment"> * @gpu_page_idx: entry in the page table to update</span><br><span class="hljs-comment"> * @addr: dst addr to write into pte/pde</span><br><span class="hljs-comment"> * @flags: access flags</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Update the page tables using CPU.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">amdgpu_gmc_set_pte_pde</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_device *adev, <span class="hljs-type">void</span> *cpu_pt_addr,</span><br><span class="hljs-params">                            <span class="hljs-type">uint32_t</span> gpu_page_idx, <span class="hljs-type">uint64_t</span> addr,</span><br><span class="hljs-params">                            <span class="hljs-type">uint64_t</span> flags)</span><br>&#123;<br>    <span class="hljs-type">void</span> __iomem *ptr = (<span class="hljs-type">void</span> *)cpu_pt_addr;<br>    <span class="hljs-type">uint64_t</span> value;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    * The following is for PTE only. GART does not have PDEs.</span><br><span class="hljs-comment">    */</span><br>    value = addr &amp; <span class="hljs-number">0x0000FFFFFFFFF000</span>ULL;<br>    value |= flags;<br>    writeq(value, ptr + (gpu_page_idx * <span class="hljs-number">8</span>));<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-3eef66d4" role="button" aria-expanded="false" aria-controls="collapse-3eef66d4">
        <div class="fold-arrow">▶</div>GEM encryption
      </div>
      <div class="fold-collapse collapse" id="collapse-3eef66d4">
        <div class="fold-content">
          <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// amdgpu-5.7.0-0\include\uapi\drm\amdgpu_drm.h:</span><br><br><span class="hljs-comment">/* Flag that BO will be encrypted and that the TMZ bit should be</span><br><span class="hljs-comment"> * set in the PTEs when mapping this buffer via GPUVM or</span><br><span class="hljs-comment"> * accessing it with various hw blocks</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AMDGPU_GEM_CREATE_ENCRYPTED  (1 &lt;&lt; 10)</span><br><br><span class="hljs-comment">/* Flag the IB as secure (TMZ)</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AMDGPU_IB_FLAGS_SECURE  (1 &lt;&lt; 5)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AMDGPU_IDS_FLAGS_TMZ            0x4</span><br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * amdgpu_bo_encrypted - test if the BO is encrypted</span><br><span class="hljs-comment"> * @bo: pointer to a buffer object</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Return true if the buffer object is encrypted, false otherwise.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">amdgpu_bo_encrypted</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_bo *bo)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> bo-&gt;flags &amp; AMDGPU_GEM_CREATE_ENCRYPTED;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * GEM ioctls.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">amdgpu_gem_create_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> drm_device *dev, <span class="hljs-type">void</span> *data,</span><br><span class="hljs-params">                            <span class="hljs-keyword">struct</span> drm_file *filp)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!amdgpu_is_tmz(adev) &amp;&amp; (flags &amp; AMDGPU_GEM_CREATE_ENCRYPTED)) &#123;<br>        DRM_NOTE_ONCE(<span class="hljs-string">&quot;Cannot allocate secure buffer since TMZ is disabled\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> -EINVAL;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">amdgpu_is_tmz</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_device *adev)</span><br>&#123;<br>       <span class="hljs-keyword">return</span> adev-&gt;gmc.tmz_enabled;<br>&#125;<br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-2a25062f" role="button" aria-expanded="false" aria-controls="collapse-2a25062f">
        <div class="fold-arrow">▶</div>BO PTE update
      </div>
      <div class="fold-collapse collapse" id="collapse-2a25062f">
        <div class="fold-content">
          <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* RV+ */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AMDGPU_PTE_TMZ  (1ULL &lt;&lt; 3)</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * amdgpu_vm_bo_update - update all BO mappings in the vm page table</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @adev: amdgpu_device pointer</span><br><span class="hljs-comment"> * @bo_va: requested BO and VM object</span><br><span class="hljs-comment"> * @clear: if true clear the entries</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Fill in the page table entries for @bo_va.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Returns:</span><br><span class="hljs-comment"> * 0 for success, -EINVAL for failure.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">amdgpu_vm_bo_update</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_device *adev, <span class="hljs-keyword">struct</span> amdgpu_bo_va *bo_va,</span><br><span class="hljs-params">                        <span class="hljs-type">bool</span> clear)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (bo) &#123;<br>        flags = amdgpu_ttm_tt_pte_flags(adev, bo-&gt;tbo.ttm, mem);<br><br>    <span class="hljs-keyword">if</span> (amdgpu_bo_encrypted(bo))<br>        flags |= AMDGPU_PTE_TMZ;<br><br>    <span class="hljs-comment">// ...</span><br>    --&gt; amdgpu_vm_update_range --&gt; amdgpu_vm_ptes_update<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * amdgpu_vm_ptes_update - make sure that page tables are valid</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @params: see amdgpu_vm_update_params definition</span><br><span class="hljs-comment"> * @start: start of GPU address range</span><br><span class="hljs-comment"> * @end: end of GPU address range</span><br><span class="hljs-comment"> * @dst: destination address to map to, the next dst inside the function</span><br><span class="hljs-comment"> * @flags: mapping flags</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Update the page tables in the range @start - @end.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Returns:</span><br><span class="hljs-comment"> * 0 for success, -EINVAL for failure.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">amdgpu_vm_ptes_update</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> amdgpu_vm_update_params *params,</span><br><span class="hljs-params">                            <span class="hljs-type">uint64_t</span> start, <span class="hljs-type">uint64_t</span> end,</span><br><span class="hljs-params">                            <span class="hljs-type">uint64_t</span> dst, <span class="hljs-type">uint64_t</span> flags, <span class="hljs-keyword">struct</span> list_head *free_list)</span><br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>


    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-fcf67c0f" role="button" aria-expanded="false" aria-controls="collapse-fcf67c0f">
        <div class="fold-arrow">▶</div>GDS set
      </div>
      <div class="fold-collapse collapse" id="collapse-fcf67c0f">
        <div class="fold-content">
          <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> GDS_VM_PROTECTION_FAULT__TMZ__SHIFT</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GDS_VM_PROTECTION_FAULT__TMZ_MASK</span><br><br><span class="hljs-comment">// addressBlock: mmhub_l1tlb_vml1dec:1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mmVML1_1_MC_VM_MX_L1_TLB0_STATUS_DEFAULT                                 0x00000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mmVML1_1_MC_VM_MX_L1_TLB1_STATUS_DEFAULT                                 0x00000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mmVML1_1_MC_VM_MX_L1_TLB2_STATUS_DEFAULT                                 0x00000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mmVML1_1_MC_VM_MX_L1_TLB3_STATUS_DEFAULT                                 0x00000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mmVML1_1_MC_VM_MX_L1_TLB4_STATUS_DEFAULT                                 0x00000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mmVML1_1_MC_VM_MX_L1_TLB5_STATUS_DEFAULT                                 0x00000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mmVML1_1_MC_VM_MX_L1_TLB6_STATUS_DEFAULT                                 0x00000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mmVML1_1_MC_VM_MX_L1_TLB7_STATUS_DEFAULT                                 0x00000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mmVML1_1_MC_VM_MX_L1_TMZ_CNTL_DEFAULT                                    0x00000000</span><br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>

<h2 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h2><ul>
<li><a href="https://blog.csdn.net/tugouxp/article/details/132819114"><strong>AMD GPU 内核驱动分析(一)总览</strong></a><ul>
<li><a href="https://blog.csdn.net/tugouxp/category_11951030.html">GPU</a></li>
<li><a href="https://edu.csdn.net/skill/cuda">CSDN CUDA 课程</a></li>
</ul>
</li>
<li><a href="https://blog.csdn.net/lsshao/article/details/122688688">虚拟内存和物理内存：从CPU和GPU交互的角度出发</a></li>
<li><a href="https://happyseeker.github.io/kernel/2016/07/22/memory-management-from-graphic-card-view.html">显卡内存管理机制及驱动实现(Intel gma500为例)</a></li>
<li><a href="https://blog.csdn.net/kunhe0512/article/details/132533305">GPU中统一内存最新机制解析</a></li>
<li><a href="https://adtxl.com/index.php/archives/316.html">Linux内存管理（19）IOMMU</a></li>
<li><a href="https://xiaolincoding.com/os/3_memory/linux_mem.html">深入理解 Linux 虚拟内存管理</a></li>
<li><a href="https://xiaolincoding.com/os/3_memory/linux_mem2.html">深入理解 Linux 物理内存管理</a></li>
<li><a href="https://www.cnblogs.com/wujianming-110117/p/17845376.html"><strong>显存架构，虚拟与物理内存</strong></a></li>
<li><a href="https://navycloud.github.io/2018/07/27/on-demand-scheduling/">AMD GPU虚拟化的按需调度策略</a></li>
<li><a href="https://blog.csdn.net/qq_40937426/article/details/127857533">Linux drm内存管理(一) 浅谈TTM与GEM，为什么我们需要TTM和GEM？</a></li>
<li><a href="https://blog.csdn.net/qq_40937426/article/details/128338947"><strong>Linux drm内存管理(二) TTM内存管理基础概念</strong></a></li>
<li><a href="https://blog.csdn.net/sty01z/article/details/134694799">drm 驱动系列 - 第三章 gem 内存管理</a></li>
<li><a href="https://blog.csdn.net/bai915290475/article/details/137436275">DRM内部结构之内存管理（二）</a></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/GPU/" class="category-chain-item">GPU</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/GPU/" class="print-no-link">#GPU</a>
      
        <a href="/tags/KMD/" class="print-no-link">#KMD</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/08/22/AI/transformer/" title="图解 Transformer">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">图解 Transformer</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/08/14/AI/Qinghua-Note/" title="2024 清华 LLM 公开课 - 笔记">
                        <span class="hidden-mobile">2024 清华 LLM 公开课 - 笔记</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.utils.listenDOMLoaded(function() {
      Fluid.events.registerRefreshCallback(function() {
        if ('mermaid' in window) {
          mermaid.init();
        }
      });
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Tech Odyssey</span></a> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>2019 - 2024 🇨🇳</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
<!-- hexo injector body_end start --><script data-pjax src="https://unpkg.com/oh-my-live2d"></script><script>const oml2d = OML2D.loadOml2d({dockedPosition:"left",mobileDisplay:false,models:[{"path":"/live2d-models/models/umaru/model.json","position":[100,30],"scale":0.25,"stageStyle":{"width":400,"height":470}},{"path":"/live2d-models/models/kobayaxi/model.json","position":[30,0],"scale":0.3,"stageStyle":{"width":400}},{"path":"/live2d-models/models/bilibili-22/index.json","position":[0,30],"scale":0.35,"stageStyle":{"width":400}},{"path":"/live2d-models/models/bilibili-33/index.json","position":[0,30],"scale":0.35,"stageStyle":{"width":400}}],parentElement:document.body,primaryColor:"#7f6f6c",tips:{style: {"left":"calc(50%)","top":"-50px"},idleTips:{interval:150}}});</script><!-- hexo injector body_end end --></body>
</html>
